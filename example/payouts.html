<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payout Form</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #bac0c5;
        opacity: 0; /* Initially hide the body */
        transition: opacity 0.5s ease-in-out; /* Smooth transition when showing */
      }
      /* Operator card styles */
      .operator-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .operator-card {
        padding: 1rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        text-align: center;
        width: 120px;
        position: relative;
        transition: transform 0.3s ease, border-color 0.3s ease;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex: 1 1 120px;
        max-width: 150px;
        cursor: pointer;
      }

      .operator-card img {
        width: 80px;
        height: auto;
        margin-bottom: 10px;
      }

      .operator-card:hover {
        transform: translateY(-5px);
        border-color: #007bff;
      }

      .operator-card.selected {
        border-color: #007bff;
        background-color: rgba(0, 123, 255, 0.1);
      }

      .operator-card.disabled {
        border-color: #ddd;
        opacity: 0.6;
        pointer-events: none;
      }

      .unavailable-text {
        color: red;
        font-size: 0.9em;
      }

      /* Responsive behavior */
      @media (max-width: 800px) {
        .operator-card {
          width: calc(50% - 20px);
        }
      }

      @media (max-width: 500px) {
        .operator-card {
          width: calc(100% - 20px);
        }
      }

      #alert-placeholder {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        z-index: 1050; /* Higher index to overlay content */
        display: none; /* Hidden by default */
      }

      #alert-placeholder .alert {
        cursor: pointer; /* Change cursor to indicate it can be clicked */
      }

      .powered-by-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .powered-by-text {
        font-size: 1rem;
        color: #555;
        margin-right: 8px;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      .pawapay-logo {
        max-width: 120px;
        height: auto;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      /* Hover effect to enhance the "ghosty" feel */
      .powered-by-text,
      .pawapay-logo {
        opacity: 0.5;
      }

      .powered-by-container:hover .powered-by-text,
      .powered-by-container:hover .pawapay-logo {
        filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.2));
      }

      .powered-by-container {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(230, 230, 230, 0.5) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        padding: 10px;
        border-radius: 5px;
      }

      .powered-by-text {
        font-size: 1rem;
        color: #333;
        margin-right: 8px;

        letter-spacing: 1px;
      }

      @media (max-width: 600px) {
        .pawapay-logo {
          max-width: 100px;
        }
      }

      #loader {
        display: flex; /* Show the loader initially */
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
        z-index: 1050; /* Ensures the loader is on top of other content */
      }

      .hidden {
        display: none !important;
      }

      .visible {
        display: flex;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5 mb-5">
      <h1 class="mb-4 text-center">Initiate Payout</h1>
      <form id="payout-form">
        <!-- Recipient Details -->
        <div id="recipients">
          <div class="recipient card mb-4 p-3">
            <div class="card-body">
              <h4 class="card-title">Recipient 1</h4>
              <!-- Country Selection -->
              <div class="mb-3">
                <label for="country-1" class="form-label">Country:</label>
                <select
                  id="country-1"
                  name="recipients[0][country]"
                  class="form-select country-select"
                >
                  <option value="" disabled selected>Choose Country</option>
                  <!-- Add countries here -->
                  <option value="Benin" data-currency="XOF">Benin</option>
                  <option value="Burkina Faso" data-currency="XOF">
                    Burkina Faso
                  </option>
                  <option value="Cameroon" data-currency="XAF">Cameroon</option>
                  <option value="Congo" data-currency="XAF">
                    Congo-Brazzaville
                  </option>
                  <option value="Congo (DRC)" data-currency="CDF">
                    Congo-Kinshasa (CDF)
                  </option>
                  <option value="Congo (DRC)" data-currency="USD">
                    Congo-Kinshasa (USD)
                  </option>
                  <option value="Cote D'Ivoire" data-currency="XOF">
                    Cote D'Ivoire
                  </option>
                  <option value="Gabon" data-currency="XAF">Gabon</option>
                  <option value="Ghana" data-currency="GHS">Ghana</option>
                  <option value="Kenya" data-currency="KES">Kenya</option>
                  <option value="Malawi" data-currency="MWK">Malawi</option>
                  <option value="Mozambique" data-currency="MZN">
                    Mozambique
                  </option>
                  <option value="Nigeria" data-currency="NGN">Nigeria</option>
                  <option value="Rwanda" data-currency="RWF">Rwanda</option>
                  <option value="Senegal" data-currency="XOF">Senegal</option>
                  <option value="Sierra Leone" data-currency="SLE">
                    Sierra Leone
                  </option>
                  <option value="Uganda" data-currency="UGX">Uganda</option>
                  <option value="Zambia" data-currency="ZMW">Zambia</option>
                  <!-- Add other countries as needed -->
                </select>
              </div>
              <!-- MNO Selection -->
              <div class="mb-3">
                <label class="form-label mb-3">Operator</label>
                <div id="mno-cards-container-1" class="operator-container">
                  <!-- MNO cards dynamically generated here -->
                </div>
                <input
                  type="hidden"
                  id="selectedMno-1"
                  name="recipients[0][correspondent]"
                  class="selected-mno-input"
                />
              </div>
              <!-- Amount with Currency Prefix -->
              <div class="mb-3">
                <label for="amount-1" class="form-label">Amount:</label>
                <div class="input-group has-validation">
                  <span class="input-group-text" id="currency-symbol-1"
                    >UGX</span
                  >
                  <input
                    type="text"
                    class="form-control amount-input"
                    id="amount-1"
                    name="recipients[0][amount]"
                    placeholder="Amount"
                    aria-label="Amount"
                  />
                </div>
              </div>
              <!-- Recipient's Phone Number -->
              <div class="mb-3">
                <label for="recipientMsisdn-1" class="form-label"
                  >Recipient's Phone Number</label
                >
                <div class="input-group">
                  <span class="input-group-text">
                    <img
                      id="countryFlag-1"
                      src="flags/ug.png"
                      alt="Flag"
                      width="24"
                      height="16"
                      class="me-2"
                    />
                    <span id="countryCode-1">+</span>
                  </span>
                  <input
                    type="tel"
                    class="form-control"
                    id="recipientMsisdn-1"
                    name="recipients[0][recipientMsisdn]"
                  />
                </div>
              </div>
              <!-- Statement Description -->
              <div class="mb-3">
                <label for="statementDescription-1" class="form-label"
                  >Statement Description</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="statementDescription-1"
                  name="recipients[0][statementDescription]"
                />
              </div>

              <!-- Metadata (Optional) -->
              <div class="mb-3">
                <label class="form-label">Metadata (Optional)</label>
                <div id="metadata-1">
                  <div class="row mb-2 metadata-item">
                    <div class="col-md-5">
                      <input
                        type="text"
                        class="form-control"
                        name="recipients[0][metadata][0][fieldName]"
                        placeholder="Field Name"
                      />
                    </div>
                    <div class="col-md-5">
                      <input
                        type="text"
                        class="form-control"
                        name="recipients[0][metadata][0][fieldValue]"
                        placeholder="Field Value"
                      />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button
                        type="button"
                        class="btn btn-outline-danger remove-metadata w-100"
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                </div>
                <button
                  type="button"
                  class="btn btn-outline-secondary add-metadata"
                  data-recipient-index="1"
                >
                  Add Metadata
                </button>
              </div>
              <!-- <button
                type="button"
                class="btn btn-outline-danger remove-recipient"
              >
                Remove Recipient
              </button> -->
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-primary" id="add-recipient">
            Add Another Recipient
          </button>
          <button type="submit" class="btn btn-success">Initiate Payout</button>
        </div>
      </form>
      <!-- Powered by Pawapay Logo -->
      <div class="powered-by-container text-center mt-4">
        <span class="powered-by-text">Powered by</span>
        <img
          src="images/powered_by_pawapay.png"
          alt="Pawapay Logo"
          class="pawapay-logo"
        />
      </div>
      <div id="alert-placeholder"></div>
      <div
        id="loader"
        class="d-flex justify-content-center align-items-center visible"
      >
        <div class="spinner-border text-light" role="status">
          <span class="visually-hidden">Processing...</span>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Include libphonenumber-js for phone number validation if needed -->
    <script src="https://unpkg.com/libphonenumber-js@1.10.22/bundle/libphonenumber-max.js"></script>

    <script>
      /* ===========================
       * Version-aware config loader
       * =========================== */
      const confVersion = "v1"; // set to "v1" or "v2" to choose which JSONs to load

      // Shared helpers + holders (outside DOMContentLoaded so all functions can use them)
      const DATA_ROOT = "../data/";
      const availabilityMap = new Map(); // provider/correspondent -> boolean
      const providerLogoMap = new Map(); // v2 only: provider -> absolute logo URL
      const v2CountryMeta = new Map(); // v2 only: ISO3 -> { prefix, flagUrl, displayName }

      // Replace tryFetchJSON with a version-detecting loader
      async function loadJSONWithVersion(paths) {
        for (const p of paths) {
          try {
            const res = await fetch(p, { cache: "no-store" });
            if (!res.ok) continue;
            const data = await res.json();

            // Heuristic: detect v2 vs v1
            // availability v2: [{country:"UGA", providers:[{provider,..., operationTypes:{PAYOUT:"OPERATIONAL"}}]}]
            // availability v1: [{country:"UGA", correspondents:[{correspondent,..., operationTypes:[{operationType:"PAYOUT",status:"OPERATIONAL"}]}]}]
            let fmt = "unknown";
            if (Array.isArray(data) && data.length) {
              const sample = data[0];
              if (
                Array.isArray(sample?.providers) ||
                (sample?.providers && typeof sample.providers === "object")
              )
                fmt = "v2";
              else if (Array.isArray(sample?.correspondents)) fmt = "v1";
            } else if (data && Array.isArray(data.countries)) {
              // active_conf v2: { countries:[{ country:"UGA", prefix:"256", flag:"...", providers:[{provider,logo}]}] }
              fmt = "v2";
            } else if (
              data &&
              (Array.isArray(data) || data.country || data.correspondents)
            ) {
              // active_conf v1/legacy â€“ anything not matching the v2 shape
              fmt = "v1";
            }

            return { data, fmt, path: p };
          } catch (_) {
            // try next
          }
        }
        return { data: null, fmt: "none", path: null };
      }

      function absorbAvailability({ isV2, data }) {
        if (!data) return;
        if (isV2) {
          // v2: [{ country:"UGA", providers:[{ provider:"MTN_MOMO_UGA", operationTypes:{PAYOUT:"OPERATIONAL",...} }]}]
          data.forEach((country) => {
            (country.providers || []).forEach((p) => {
              const op = p.operationTypes || {};
              const ok =
                String(op.PAYOUT || "").toUpperCase() === "OPERATIONAL";
              availabilityMap.set(p.provider, ok);
            });
          });
        } else {
          // v1: [{ country:"UGA", correspondents:[{ correspondent:"MTN_MOMO_UGA", operationTypes:[{operationType:"PAYOUT",status:"OPERATIONAL"}]}]}]
          data.forEach((country) => {
            (country.correspondents || []).forEach((c) => {
              const arr = c.operationTypes || [];
              const pay = arr.find(
                (x) => String(x.operationType).toUpperCase() === "PAYOUT"
              );
              const ok =
                pay && String(pay.status || "").toUpperCase() === "OPERATIONAL";
              availabilityMap.set(c.correspondent, !!ok);
            });
          });
        }
      }

      function absorbV2ActiveConf(active) {
        if (!active || !Array.isArray(active.countries)) return;
        active.countries.forEach((cty) => {
          if (cty.country) {
            v2CountryMeta.set(cty.country, {
              prefix: cty.prefix ? String(cty.prefix) : "",
              flagUrl: cty.flag || "",
              displayName:
                (cty.displayName &&
                  (cty.displayName.en || cty.displayName.fr)) ||
                cty.country,
            });
          }
          (cty.providers || []).forEach((p) => {
            if (p.provider && p.logo) providerLogoMap.set(p.provider, p.logo);
          });
        });
      }

      async function loadConfigs({ mnoCorrespondents, countryNameToCode }) {
        const isV2 = String(confVersion).toLowerCase() === "v2";

        // Availability (prefer versioned, then legacy fallback)
        const { data: availability, fmt: availabilityFmt } =
          await loadJSONWithVersion(
            isV2
              ? [
                  DATA_ROOT + "mno_availability_v2.json",
                  DATA_ROOT + "mno_availability.json",
                  DATA_ROOT + "mno_availability_v1.json",
                ]
              : [
                  DATA_ROOT + "mno_availability_v1.json",
                  DATA_ROOT + "mno_availability.json",
                ]
          );
        // Use the file's actual format, not the UI toggle
        absorbAvailability({
          isV2: availabilityFmt === "v2",
          data: availability,
        });

        // Active conf (for v2 logos, flags, prefixes). Fallback to legacy names.
        const { data: active, fmt: activeFmt } = await loadJSONWithVersion(
          isV2
            ? [
                DATA_ROOT + "active_conf_v2.json",
                DATA_ROOT + "active_conf.json",
                DATA_ROOT + "active_conf_v1.json",
              ]
            : [
                DATA_ROOT + "active_conf_v1.json", // try v1 first when UI is v1
                DATA_ROOT + "active_conf.json",
              ]
        );
        // Only absorb v2 fields if the loaded file is actually v2
        if (activeFmt === "v2") absorbV2ActiveConf(active);

        // Merge availability + logos + prefixes into your in-memory operators
        Object.keys(mnoCorrespondents).forEach((countryName) => {
          const countryIso3 = countryNameToCode[countryName];
          const meta = v2CountryMeta.get(countryIso3) || null;

          mnoCorrespondents[countryName].forEach((mno) => {
            // Availability
            const status = availabilityMap.get(mno.apiCode);
            mno.available = typeof status === "boolean" ? status : false;

            // v2 logo URLs (absolute). If not found, keep local image.
            const logo = providerLogoMap.get(mno.apiCode);
            if (logo) mno.img = logo;

            // v2 country dial prefix override (shown before phone input)
            if (meta && meta.prefix) {
              mno.countryCode = `+${meta.prefix}`;
            }
          });
        });
      }

      function extractResponseData(r) {
        if (!r) return {};
        if (Array.isArray(r)) return r[0] || {};
        if (r.data && typeof r.data === "object") return r.data; // v2 shape
        return r;
      }

      window.addEventListener("load", function () {
        document.body.style.opacity = "1";
        document.getElementById("loader").classList.add("hidden");
      });

      document.addEventListener("DOMContentLoaded", function () {
        let recipientIndex = 1;
        let maxRecipients = 5;
        let maxMetadata = 5;

        // MNO Correspondents Data (seed; availability + logos updated by loader)
        const mnoCorrespondents = {
          Benin: [
            {
              name: "MTN Benin",
              apiCode: "MTN_MOMO_BEN",
              countryCode: "+229",
              flag: "bj.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Moov Benin",
              apiCode: "MOOV_BEN",
              countryCode: "+229",
              flag: "bj.png",
              available: false,
              img: "moov.png",
            },
          ],
          "Burkina Faso": [
            {
              name: "Orange Burkina Faso",
              apiCode: "ORANGE_BFA",
              countryCode: "+226",
              flag: "bf.png",
              available: true,
              img: "orange-money-logo.jpg",
            },
            {
              name: "Moov Burkina Faso",
              apiCode: "MOOV_BFA",
              countryCode: "+226",
              flag: "bf.png",
              available: true,
              img: "moov.png",
            },
          ],
          Cameroon: [
            {
              name: "MTN Cameroon",
              apiCode: "MTN_MOMO_CMR",
              countryCode: "+237",
              flag: "cm.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Orange Cameroon",
              apiCode: "ORANGE_CMR",
              countryCode: "+237",
              flag: "cm.png",
              available: true,
              img: "orange-money-logo.jpg",
            },
          ],
          Congo: [
            {
              name: "Airtel Congo",
              apiCode: "AIRTEL_COG",
              countryCode: "+242",
              flag: "cg.png",
              available: false,
              img: "airtel.png",
            },
          ],
          "Congo (DRC)": [
            {
              name: "Vodacom DRC",
              apiCode: "VODACOM_MPESA_COD",
              countryCode: "+243",
              flag: "cd.png",
              available: true,
              img: "vodacom.jpg",
            },
            {
              name: "Airtel DRC",
              apiCode: "AIRTEL_COD",
              countryCode: "+243",
              flag: "cd.png",
              available: true,
              img: "airtel.png",
            },
            {
              name: "Orange DRC",
              apiCode: "ORANGE_COD",
              countryCode: "+243",
              flag: "cd.png",
              available: false,
              img: "orange-money-logo.jpg",
            },
          ],
          "Cote D'Ivoire": [
            {
              name: "MTN Cote d'Ivoire",
              apiCode: "MTN_MOMO_CIV",
              countryCode: "+225",
              flag: "ci.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Orange Cote d'Ivoire",
              apiCode: "ORANGE_CIV",
              countryCode: "+225",
              flag: "ci.png",
              available: true,
              img: "orange-money-logo.jpg",
            },
            {
              name: "Moov Cote d'Ivoire",
              apiCode: "MOOV_CIV",
              countryCode: "+225",
              flag: "ci.png",
              available: true,
              img: "moov.png",
            },
            {
              name: "Wave Cote d'Ivoire",
              apiCode: "WAVE_CIV",
              countryCode: "+225",
              flag: "ci.png",
              available: true,
              img: "wave-logo.png",
            },
          ],
          Gabon: [
            {
              name: "Airtel Gabon",
              apiCode: "AIRTEL_GAB",
              countryCode: "+241",
              flag: "ga.png",
              available: true,
              img: "airtel.png",
            },
            {
              name: "Moov Gabon",
              apiCode: "MOOV_GAB",
              countryCode: "+241",
              flag: "ga.png",
              available: true,
              img: "moov.png",
            },
          ],
          Ghana: [
            {
              name: "MTN Ghana",
              apiCode: "MTN_MOMO_GHA",
              countryCode: "+233",
              flag: "gh.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "AirtelTigo Ghana",
              apiCode: "AIRTELTIGO_GHA",
              countryCode: "+233",
              flag: "gh.png",
              available: true,
              img: "airtel-tigo.png",
            },
            {
              name: "Vodafone Ghana",
              apiCode: "VODAFONE_GHA",
              countryCode: "+233",
              flag: "gh.png",
              available: true,
              img: "vodacom.jpg",
            },
          ],
          Kenya: [
            {
              name: "Safaricom Kenya",
              apiCode: "MPESA_KEN",
              countryCode: "+254",
              flag: "ke.png",
              available: true,
              img: "safaricom-logo.png",
            },
            {
              name: "Airtel Kenya",
              apiCode: "AIRTEL_KEN",
              countryCode: "+254",
              flag: "ke.png",
              available: true,
              img: "airtel.png",
            },
          ],
          Malawi: [
            {
              name: "Airtel Malawi",
              apiCode: "AIRTEL_MWI",
              countryCode: "+265",
              flag: "mw.png",
              available: true,
              img: "airtel.png",
            },
            {
              name: "TNM Malawi",
              apiCode: "TNM_MWI",
              countryCode: "+265",
              flag: "mw.png",
              available: true,
              img: "mw-tnm-logo.png",
            },
          ],
          Mozambique: [
            {
              name: "Vodacom Mozambique",
              apiCode: "VODACOM_MOZ",
              countryCode: "+258",
              flag: "mz.png",
              available: true,
              img: "vodacom.jpg",
            },
            {
              name: "Movitel Mozambique",
              apiCode: "MOVITEL_MOZ",
              countryCode: "+258",
              flag: "mz.png",
              available: true,
              img: "movitel.png",
            },
          ],
          Nigeria: [
            {
              name: "MTN Nigeria",
              apiCode: "MTN_MOMO_NGA",
              countryCode: "+234",
              flag: "ng.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Airtel Nigeria",
              apiCode: "AIRTEL_NGA",
              countryCode: "+234",
              flag: "ng.png",
              available: true,
              img: "airtel.png",
            },
          ],
          Rwanda: [
            {
              name: "MTN Rwanda",
              apiCode: "MTN_MOMO_RWA",
              countryCode: "+250",
              flag: "rw.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Airtel Rwanda",
              apiCode: "AIRTEL_RWA",
              countryCode: "+250",
              flag: "rw.png",
              available: true,
              img: "airtel.png",
            },
          ],
          Senegal: [
            {
              name: "Orange Senegal",
              apiCode: "ORANGE_SEN",
              countryCode: "+221",
              flag: "sn.png",
              available: true,
              img: "orange-money-logo.jpg",
            },
            {
              name: "Free Senegal",
              apiCode: "FREE_SEN",
              countryCode: "+221",
              flag: "sn.png",
              available: true,
              img: "free.png",
            },
          ],
          "Sierra Leone": [
            {
              name: "Orange Sierra Leone",
              apiCode: "ORANGE_SLE",
              countryCode: "+232",
              flag: "sl.png",
              available: true,
              img: "orange-money-logo.jpg",
            },
            {
              name: "Africell Sierra Leone",
              apiCode: "AFRICELL_SLE",
              countryCode: "+232",
              flag: "sl.png",
              available: true,
              img: "africell.png",
            },
          ],
          Tanzania: [
            {
              name: "Vodacom Tanzania",
              apiCode: "VODACOM_TZA",
              countryCode: "+255",
              flag: "tz.png",
              available: true,
              img: "vodacom.jpg",
            },
            {
              name: "Airtel Tanzania",
              apiCode: "AIRTEL_TZA",
              countryCode: "+255",
              flag: "tz.png",
              available: true,
              img: "airtel.png",
            },
            {
              name: "Tigo Tanzania",
              apiCode: "TIGO_TZA",
              countryCode: "+255",
              flag: "tz.png",
              available: true,
              img: "tigo-pesa-tanzania.png",
            },
            {
              name: "Halotel Tanzania",
              apiCode: "HALOTEL_TZA",
              countryCode: "+255",
              flag: "tz.png",
              available: true,
              img: "halotel-tz.png",
            },
          ],
          Uganda: [
            {
              name: "MTN Uganda",
              apiCode: "MTN_MOMO_UGA",
              countryCode: "+256",
              flag: "ug.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Airtel Uganda",
              apiCode: "AIRTEL_OAPI_UGA",
              countryCode: "+256",
              flag: "ug.png",
              available: true,
              img: "airtel.png",
            },
          ],
          Zambia: [
            {
              name: "MTN Zambia",
              apiCode: "MTN_MOMO_ZMB",
              countryCode: "+260",
              flag: "zm.png",
              available: true,
              img: "mtn.png",
            },
            {
              name: "Airtel Zambia",
              apiCode: "AIRTEL_OAPI_ZMB",
              countryCode: "+260",
              flag: "zm.png",
              available: true,
              img: "airtel.png",
            },
            {
              name: "Zamtel Zambia",
              apiCode: "ZAMTEL_ZMB",
              countryCode: "+260",
              flag: "zm.png",
              available: false,
              img: "zamtel-za.png",
            },
          ],
        };

        // Country names to ISO3
        const countryNameToCode = {
          Algeria: "DZA",
          Angola: "AGO",
          Benin: "BEN",
          Botswana: "BWA",
          "Burkina Faso": "BFA",
          Burundi: "BDI",
          "Cabo Verde": "CPV",
          Cameroon: "CMR",
          "Central African Republic": "CAF",
          Chad: "TCD",
          Comoros: "COM",
          Congo: "COG",
          "Congo (DRC)": "COD",
          "Cote D'Ivoire": "CIV",
          Djibouti: "DJI",
          Egypt: "EGY",
          "Equatorial Guinea": "GNQ",
          Eritrea: "ERI",
          Eswatini: "SWZ",
          Ethiopia: "ETH",
          Gabon: "GAB",
          Gambia: "GMB",
          Ghana: "GHA",
          Guinea: "GIN",
          "Guinea-Bissau": "GNB",
          Kenya: "KEN",
          Lesotho: "LSO",
          Liberia: "LBR",
          Libya: "LBY",
          Madagascar: "MDG",
          Malawi: "MWI",
          Mali: "MLI",
          Mauritania: "MRT",
          Mauritius: "MUS",
          Morocco: "MAR",
          Mozambique: "MOZ",
          Namibia: "NAM",
          Niger: "NER",
          Nigeria: "NGA",
          Rwanda: "RWA",
          "Sao Tome and Principe": "STP",
          Senegal: "SEN",
          Seychelles: "SYC",
          "Sierra Leone": "SLE",
          Somalia: "SOM",
          "South Africa": "ZAF",
          "South Sudan": "SSD",
          Sudan: "SDN",
          Tanzania: "TZA",
          Togo: "TGO",
          Tunisia: "TUN",
          Uganda: "UGA",
          Zambia: "ZMB",
          Zimbabwe: "ZWE",
        };

        // Load availability + logos (v1/v2) and merge into mnoCorrespondents
        loadConfigs({ mnoCorrespondents, countryNameToCode }).catch((err) =>
          console.error("Config load error:", err)
        );

        function showBootstrapAlert(message, type = "warning") {
          const alertPlaceholder = document.getElementById("alert-placeholder");
          alertPlaceholder.style.display = "flex";
          alertPlaceholder.style.justifyContent = "center";
          alertPlaceholder.style.alignItems = "center";
          alertPlaceholder.style.padding = "20px";

          const wrapper = document.createElement("div");
          wrapper.style.maxWidth = "800px";
          wrapper.style.width = "100%";
          wrapper.style.margin = "0 auto";
          wrapper.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
          wrapper.style.borderRadius = "8px";
          wrapper.style.overflowY = "auto";
          wrapper.style.maxHeight = "80vh";

          wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
            `   <span>${message}</span>`,
            `   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`,
            `</div>`,
          ].join("");

          wrapper.addEventListener("click", function () {
            alertPlaceholder.style.display = "none";
          });

          alertPlaceholder.innerHTML = "";
          alertPlaceholder.append(wrapper);
        }

        function showSuccessAlert(message) {
          const alertPlaceholder = document.getElementById("alert-placeholder");
          alertPlaceholder.style.display = "flex";
          alertPlaceholder.style.justifyContent = "center";
          alertPlaceholder.style.alignItems = "center";
          alertPlaceholder.style.padding = "20px";

          const wrapper = document.createElement("div");
          wrapper.style.maxWidth = "500px";
          wrapper.style.width = "100%";
          wrapper.style.margin = "0 auto";
          wrapper.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
          wrapper.style.borderRadius = "8px";

          wrapper.innerHTML = [
            `<div class="alert alert-success alert-dismissible fade show" role="alert">`,
            `   <strong>Success!</strong> ${message}`,
            `   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`,
            `</div>`,
          ].join("");

          wrapper.addEventListener("click", function () {
            alertPlaceholder.style.display = "none";
          });

          alertPlaceholder.innerHTML = "";
          alertPlaceholder.append(wrapper);
        }

        // Add recipient button
        document
          .getElementById("add-recipient")
          .addEventListener("click", function () {
            if (recipientIndex >= maxRecipients) {
              showBootstrapAlert(
                "You can only add up to 5 recipients.",
                "danger"
              );
              return;
            }
            recipientIndex++;
            const recipientsDiv = document.getElementById("recipients");

            const recipientDiv = document.createElement("div");
            recipientDiv.classList.add("recipient", "card", "mb-4", "p-3");

            recipientDiv.innerHTML = `
          <div class="card-body">
              <h4 class="card-title">Recipient ${recipientIndex}</h4>
              <!-- Country Selection -->
              <div class="mb-3">
                  <label for="country-${recipientIndex}" class="form-label">Country:</label>
                  <select id="country-${recipientIndex}" name="recipients[${
              recipientIndex - 1
            }][country]" class="form-select country-select">
                      <option value="" disabled selected>Choose Country</option>
                      <option value="Benin" data-currency="XOF">Benin</option>
                      <option value="Burkina Faso" data-currency="XOF">Burkina Faso</option>
                      <option value="Cameroon" data-currency="XAF">Cameroon</option>
                      <option value="Congo" data-currency="XAF">Congo-Brazzaville</option>
                      <option value="Congo (DRC)" data-currency="CDF">Congo-Kinshasa (CDF)</option>
                      <option value="Congo (DRC)" data-currency="USD">Congo-Kinshasa (USD)</option>
                      <option value="Cote D'Ivoire" data-currency="XOF">Cote D'Ivoire</option>
                      <option value="Gabon" data-currency="XAF">Gabon</option>
                      <option value="Ghana" data-currency="GHS">Ghana</option>
                      <option value="Kenya" data-currency="KES">Kenya</option>
                      <option value="Malawi" data-currency="MWK">Malawi</option>
                      <option value="Mozambique" data-currency="MZN">Mozambique</option>
                      <option value="Nigeria" data-currency="NGN">Nigeria</option>
                      <option value="Rwanda" data-currency="RWF">Rwanda</option>
                      <option value="Senegal" data-currency="XOF">Senegal</option>
                      <option value="Sierra Leone" data-currency="SLE">Sierra Leone</option>
                      <option value="Uganda" data-currency="UGX">Uganda</option>
                      <option value="Zambia" data-currency="ZMW">Zambia</option>
                  </select>
              </div>
              <!-- MNO Selection -->
              <div class="mb-3">
                  <label class="form-label mb-3">Operator</label>
                  <div id="mno-cards-container-${recipientIndex}" class="operator-container"></div>
                  <input type="hidden" id="selectedMno-${recipientIndex}" name="recipients[${
              recipientIndex - 1
            }][correspondent]" class="selected-mno-input" />
              </div>
              <!-- Amount with Currency Prefix -->
              <div class="mb-3">
                  <label for="amount-${recipientIndex}" class="form-label">Amount:</label>
                  <div class="input-group has-validation">
                      <span class="input-group-text" id="currency-symbol-${recipientIndex}"></span>
                      <input type="text" class="form-control amount-input" id="amount-${recipientIndex}" name="recipients[${
              recipientIndex - 1
            }][amount]" placeholder="Amount" aria-label="Amount" />
                  </div>
              </div>
              <!-- Recipient's Phone Number -->
              <div class="mb-3">
                  <label for="recipientMsisdn-${recipientIndex}" class="form-label">Recipient's Phone Number</label>
                  <div class="input-group">
                      <span class="input-group-text">
                          <img id="countryFlag-${recipientIndex}" src="" alt="Flag" width="24" height="16" class="me-2" />
                          <span id="countryCode-${recipientIndex}">+</span>
                      </span>
                      <input type="tel" class="form-control" id="recipientMsisdn-${recipientIndex}" name="recipients[${
              recipientIndex - 1
            }][recipientMsisdn]" >
                  </div>
              </div>
              <!-- Statement Description -->
              <div class="mb-3">
                  <label for="statementDescription-${recipientIndex}" class="form-label">Statement Description</label>
                  <input type="text" class="form-control" id="statementDescription-${recipientIndex}" name="recipients[${
              recipientIndex - 1
            }][statementDescription]">
              </div>
              <!-- Metadata (Optional) -->
              <div class="mb-3">
                  <label class="form-label">Metadata (Optional)</label>
                  <div id="metadata-${recipientIndex}">
                      <div class="row mb-2 metadata-item">
                          <div class="col-md-5">
                              <input type="text" class="form-control" name="recipients[${
                                recipientIndex - 1
                              }][metadata][0][fieldName]" placeholder="Field Name">
                          </div>
                          <div class="col-md-5">
                              <input type="text" class="form-control" name="recipients[${
                                recipientIndex - 1
                              }][metadata][0][fieldValue]" placeholder="Field Value">
                          </div>
                          <div class="col-md-2 d-flex align-items-end">
                              <button type="button" class="btn btn-outline-danger remove-metadata w-100">Remove</button>
                          </div>
                      </div>
                  </div>
                  <button type="button" class="btn btn-outline-secondary add-metadata" data-recipient-index="${recipientIndex}">Add Metadata</button>
              </div>
              <button type="button" class="btn btn-outline-danger remove-recipient">Remove Recipient</button>
          </div>
        `;
            recipientsDiv.appendChild(recipientDiv);
          });

        // Remove recipient
        document
          .getElementById("recipients")
          .addEventListener("click", function (event) {
            if (
              event.target &&
              event.target.classList.contains("remove-recipient")
            ) {
              const recipientCard = event.target.closest(".recipient");
              recipientCard.parentNode.removeChild(recipientCard);
            }
          });

        // Add metadata
        document
          .getElementById("recipients")
          .addEventListener("click", function (event) {
            if (
              event.target &&
              event.target.classList.contains("add-metadata")
            ) {
              const recipientIndex = event.target.getAttribute(
                "data-recipient-index"
              );
              const container = document.getElementById(
                "metadata-" + recipientIndex
              );
              const items = container.querySelectorAll(".metadata-item");
              if (items.length >= maxMetadata) {
                document.getElementById("loader").classList.add("hidden");
                showBootstrapAlert(
                  "You can only add up to 5 metadata entries per recipient.",
                  "danger"
                );
                return;
              }
              const idx = items.length;
              const row = document.createElement("div");
              row.classList.add("row", "mb-2", "metadata-item");
              row.innerHTML = `
            <div class="col-md-5">
              <input type="text" class="form-control" name="recipients[${
                recipientIndex - 1
              }][metadata][${idx}][fieldName]" placeholder="Field Name">
            </div>
            <div class="col-md-5">
              <input type="text" class="form-control" name="recipients[${
                recipientIndex - 1
              }][metadata][${idx}][fieldValue]" placeholder="Field Value">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button type="button" class="btn btn-outline-danger remove-metadata w-100">Remove</button>
            </div>`;
              container.appendChild(row);
            }
          });

        // Remove metadata
        document
          .getElementById("recipients")
          .addEventListener("click", function (event) {
            if (
              event.target &&
              event.target.classList.contains("remove-metadata")
            ) {
              const item = event.target.closest(".metadata-item");
              item.parentNode.removeChild(item);
            }
          });

        // Country change
        document
          .getElementById("recipients")
          .addEventListener("change", function (event) {
            if (
              event.target &&
              event.target.classList.contains("country-select")
            ) {
              const recipientCard = event.target.closest(".recipient");
              const recipientIndex = getRecipientIndex(recipientCard);
              const selectedCountry = event.target.value;
              const selectedOption =
                event.target.options[event.target.selectedIndex];
              const currency = selectedOption.getAttribute("data-currency");

              // Currency prefix
              const currencySymbolSpan = recipientCard.querySelector(
                "#currency-symbol-" + recipientIndex
              );
              currencySymbolSpan.textContent = currency;

              // Country details + cards
              updateCountryDetails(recipientIndex, selectedCountry);
              displayMnoCards(recipientIndex, selectedCountry);
            }
          });

        function getRecipientIndex(recipientCard) {
          const title = recipientCard.querySelector(".card-title").textContent;
          const match = title.match(/Recipient (\d+)/);
          return match ? parseInt(match[1]) : 1;
        }

        // Prefer v2 meta (prefix/flag), fallback to v1 data
        function updateCountryDetails(recipientIndex, country) {
          const countryIso3 = countryNameToCode[country];
          const meta = v2CountryMeta.get(countryIso3);
          if (meta) {
            document.getElementById(
              "countryCode-" + recipientIndex
            ).textContent = "+" + (meta.prefix || "");
            const flagEl = document.getElementById(
              "countryFlag-" + recipientIndex
            );
            flagEl.src = meta.flagUrl || "";
            flagEl.alt = (meta.displayName || country) + " flag";
            return;
          }
          const correspondents = mnoCorrespondents[country];
          if (correspondents && correspondents.length > 0) {
            const cc = correspondents[0].countryCode || "+";
            const flag = correspondents[0].flag || "";
            document.getElementById(
              "countryCode-" + recipientIndex
            ).textContent = cc;
            const flagEl = document.getElementById(
              "countryFlag-" + recipientIndex
            );
            flagEl.src = flag ? "flags/" + flag : "";
            flagEl.alt = country + " flag";
          } else {
            document.getElementById(
              "countryCode-" + recipientIndex
            ).textContent = "+";
            const flagEl = document.getElementById(
              "countryFlag-" + recipientIndex
            );
            flagEl.src = "";
            flagEl.alt = "";
          }
        }

        // Operator cards (absolute URLs in v2; local images in v1)
        function displayMnoCards(recipientIndex, country) {
          const container = document.getElementById(
            "mno-cards-container-" + recipientIndex
          );
          container.innerHTML = "";

          const correspondents = mnoCorrespondents[country];
          if (!correspondents) {
            container.textContent = "No MNO available for this country";
            return;
          }

          correspondents.forEach((mno) => {
            const card = document.createElement("div");
            card.className = `operator-card ${mno.available ? "" : "disabled"}`;

            const isAbsolute =
              typeof mno.img === "string" && /^(https?:)?\/\//i.test(mno.img);
            const logoSrc = isAbsolute ? mno.img : `mno-img/${mno.img}`;

            card.innerHTML = `
          <img src="${logoSrc}" alt="${mno.name}" />
          <p>${mno.name}</p>
          ${
            mno.available
              ? ""
              : '<span class="unavailable-text">Not available</span>'
          }
        `;

            card.onclick = function () {
              if (!mno.available) return;

              container
                .querySelectorAll(".operator-card")
                .forEach((c) => c.classList.remove("selected"));
              card.classList.add("selected");

              // Backend maps v1/v2 (correspondent <-> provider)
              document.getElementById("selectedMno-" + recipientIndex).value =
                mno.apiCode;

              // Refresh prefix/flag (v2 meta takes precedence)
              updateCountryDetails(recipientIndex, country);
            };

            container.appendChild(card);
          });
        }

        // Submit handler
        document
          .getElementById("payout-form")
          .addEventListener("submit", function (event) {
            event.preventDefault();

            const loader = document.getElementById("loader");
            loader.style.display = "flex";
            loader.classList.remove("hidden");
            loader.classList.add("visible");

            const validationErrors = validateForm();
            if (validationErrors.length > 0) {
              const errorMessage = createDynamicErrorMessage(validationErrors);
              showBootstrapAlert(errorMessage, "warning");
              loader.style.display = "none";
              loader.classList.add("hidden");
              return;
            }

            // Build JSON body
            const formData = new FormData(this);
            const formJSON = {};
            formData.forEach((value, key) => {
              const keys = key.match(/[^\[\]]+/g);
              let ref = formJSON;
              keys.forEach((k, i) => {
                if (i < keys.length - 1) {
                  if (!ref[k]) {
                    ref[k] = isNaN(keys[i + 1]) ? {} : [];
                  }
                  ref = ref[k];
                } else {
                  if (k === "recipientMsisdn") {
                    const rIdx = parseInt(keys[1]) + 1;
                    const countryCodeSpan = document.getElementById(
                      `countryCode-${rIdx}`
                    );
                    let cleaned = value.replace(/\D/g, "");
                    if (countryCodeSpan) {
                      let countryCode = countryCodeSpan.textContent
                        .trim()
                        .replace("+", "");
                      ref[k] = countryCode + cleaned;
                    } else {
                      ref[k] = cleaned;
                    }
                  } else if (k === "amount") {
                    const rIdx = parseInt(keys[1]) + 1;
                    const currencySpan = document.getElementById(
                      `currency-symbol-${rIdx}`
                    );
                    if (currencySpan) {
                      const currency = currencySpan.textContent.trim();
                      ref["currency"] = currency;
                    }
                    ref[k] = value;
                  } else {
                    ref[k] = value;
                  }
                }
              });
            });

            // Tell backend which API shape the UI intends to use
            formJSON.apiVersion = confVersion;

            fetch("payouts.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formJSON),
            })
              .then((response) => response.json())
              .then((data) => {
                loader.style.display = "none";
                loader.classList.add("hidden");
                console.log(data);

                let successMessages = "";
                let failureMessages = "";

                if (
                  data.successful_payouts &&
                  Array.isArray(data.successful_payouts) &&
                  data.successful_payouts.length > 0
                ) {
                  successMessages += `<h5>Successful Payouts:</h5><ul>`;
                  data.successful_payouts.forEach((payout) => {
                    successMessages += `
                  <li>
                    <strong>Recipient:</strong> ${payout.recipientMsisdn}<br>
                    <strong>Amount:</strong> ${payout.amount} ${payout.currency}<br>
                    <strong>Payout ID:</strong> ${payout.payoutId}<br>
                    <strong>Details:</strong> ${payout.details}
                  </li>`;
                  });
                  successMessages += `</ul>`;
                }

                if (
                  data.failed_payouts &&
                  Array.isArray(data.failed_payouts) &&
                  data.failed_payouts.length > 0
                ) {
                  failureMessages += `<h5>Failed Payouts:</h5><ul>`;
                  data.failed_payouts.forEach((payout) => {
                    failureMessages += `
                  <li>
                    <strong>Recipient:</strong> ${payout.recipientMsisdn}<br>
                    <strong>Amount:</strong> ${payout.amount} ${
                      payout.currency
                    }<br>
                    <strong>Payout ID:</strong> ${payout.payoutId || "N/A"}<br>
                    <strong>Reason:</strong> ${payout.error}<br>
                    <strong>Details:</strong> ${payout.details}
                  </li>`;
                  });
                  failureMessages += `</ul>`;
                }

                if (
                  (!data.successful_payouts ||
                    data.successful_payouts.length === 0) &&
                  data.responses &&
                  Array.isArray(data.responses) &&
                  data.responses.length > 0
                ) {
                  data.responses.forEach((payout) => {
                    if (payout.success) {
                      const responseData = extractResponseData(payout.response);
                      successMessages += `
                    <h5>Successful Payout:</h5>
                    <ul>
                      <li>
                        <strong>Recipient:</strong> ${
                          payout.recipientMsisdn
                        }<br>
                        <strong>Amount:</strong> ${
                          responseData.amount || "N/A"
                        } ${responseData.currency || ""}<br>
                        <strong>Payout ID:</strong> ${
                          responseData.payoutId || "N/A"
                        }<br>
                        <strong>Details:</strong> ${payout.details}
                      </li>
                    </ul>`;
                    } else {
                      const responseData =
                        payout.response && payout.response.length > 0
                          ? payout.response[0]
                          : {};
                      failureMessages += `
                    <h5>Failed Payout:</h5>
                    <ul>
                      <li>
                        <strong>Recipient:</strong> ${
                          payout.recipientMsisdn
                        }<br>
                        <strong>Amount:</strong> ${payout.amount || "N/A"} ${
                        payout.currency || ""
                      }<br>
                        <strong>Payout ID:</strong> ${
                          responseData.payoutId || "N/A"
                        }<br>
                        <strong>Reason:</strong> ${payout.error || "N/A"}<br>
                        <strong>Details:</strong> ${payout.details}
                      </li>
                    </ul>`;
                    }
                  });
                }

                let combinedMessage = "";
                if (successMessages) combinedMessage += successMessages;
                if (failureMessages) combinedMessage += failureMessages;

                if (combinedMessage) {
                  if (data.success) {
                    showSuccessAlert(combinedMessage);
                  } else {
                    showBootstrapAlert(combinedMessage);
                  }
                } else {
                  showBootstrapAlert(
                    "No payouts were processed. Please check your input.",
                    "warning"
                  );
                }
              })
              .catch((error) => {
                loader.style.display = "none";
                loader.classList.add("hidden");
                console.error("Error:", error);
                showBootstrapAlert(
                  "There was an error sending the request.",
                  "danger"
                );
              });
          });

        function displayDetailedErrors(responses) {
          document.getElementById("loader").classList.add("hidden");
          let message = "Please review the following issues:<ul>";
          responses.forEach((response, index) => {
            message += `<li>Recipient ${index + 1}: ${response.details}</li>`;
          });
          message += "</ul>";
          showBootstrapAlert(message, "warning");
        }

        function validateForm() {
          const isV2 = String(confVersion).toLowerCase() === "v2";
          const recipients = document.querySelectorAll(".recipient");
          const errors = [];

          recipients.forEach((recipient, index) => {
            const countrySelect = recipient.querySelector(".country-select");
            const selectedMnoInput = recipient.querySelector(
              ".selected-mno-input"
            );
            const amountInput = recipient.querySelector(".amount-input");
            const phoneNumberInput = recipient.querySelector(
              "[name^='recipients'][name$='[recipientMsisdn]']"
            );
            const statementDescriptionInput = recipient.querySelector(
              "[name^='recipients'][name$='[statementDescription]']"
            );
            const metadataItems = recipient.querySelectorAll(".metadata-item");

            const recErrs = [];

            if (!countrySelect.value) {
              recErrs.push("Country");
              countrySelect.classList.add("is-invalid");
            } else {
              countrySelect.classList.remove("is-invalid");
            }

            if (!selectedMnoInput.value) {
              recErrs.push("Operator");
              recipient
                .querySelector(".operator-container")
                .classList.add("border-danger");
            } else {
              recipient
                .querySelector(".operator-container")
                .classList.remove("border-danger");
            }

            if (
              !amountInput.value ||
              isNaN(amountInput.value) ||
              parseFloat(amountInput.value) <= 0
            ) {
              recErrs.push("Amount");
              amountInput.classList.add("is-invalid");
            } else {
              amountInput.classList.remove("is-invalid");
            }

            const countryCodeSpan = recipient.querySelector(
              `#countryCode-${index + 1}`
            );
            let fullPhoneNumber = phoneNumberInput.value.trim();
            let countryCode = "";

            if (countryCodeSpan) {
              countryCode = countryCodeSpan.textContent.trim().replace("+", "");
              fullPhoneNumber = countryCode + fullPhoneNumber;
            }
            const cleanedPhoneNumber = fullPhoneNumber.replace(/\D/g, "");

            if (!cleanedPhoneNumber || !/^\d+$/.test(cleanedPhoneNumber)) {
              recErrs.push(
                "Invalid Phone Number (should contain only numbers)"
              );
              phoneNumberInput.classList.add("is-invalid");
            } else {
              const phoneNumber = libphonenumber.parsePhoneNumberFromString(
                `+${cleanedPhoneNumber}`
              );
              if (!phoneNumber || !phoneNumber.isValid()) {
                recErrs.push("Invalid Phone Number");
                phoneNumberInput.classList.add("is-invalid");
              } else {
                phoneNumberInput.classList.remove("is-invalid");
              }
            }

            // Statement description:
            // v1: required; v2: optional (but if provided, must meet format)
            const descVal = (statementDescriptionInput.value || "").trim();
            if (!isV2) {
              if (!descVal) {
                recErrs.push("Statement Description is required");
                statementDescriptionInput.classList.add("is-invalid");
              } else if (descVal.length > 22) {
                recErrs.push(
                  "Statement Description must be 22 characters or less"
                );
                statementDescriptionInput.classList.add("is-invalid");
              } else if (!/^[a-zA-Z0-9\s]+$/.test(descVal)) {
                recErrs.push(
                  "Statement Description must not contain special characters"
                );
                statementDescriptionInput.classList.add("is-invalid");
              } else {
                statementDescriptionInput.classList.remove("is-invalid");
              }
            } else if (descVal) {
              // optional in v2, but validate when present
              if (descVal.length > 22) {
                recErrs.push(
                  "Statement Description must be 22 characters or less"
                );
                statementDescriptionInput.classList.add("is-invalid");
              } else if (!/^[a-zA-Z0-9\s]+$/.test(descVal)) {
                recErrs.push(
                  "Statement Description must not contain special characters"
                );
                statementDescriptionInput.classList.add("is-invalid");
              } else {
                statementDescriptionInput.classList.remove("is-invalid");
              }
            } else {
              statementDescriptionInput.classList.remove("is-invalid");
            }

            // Metadata fields (if present)
            metadataItems.forEach((metadataItem, metadataIndex) => {
              const fieldNameInput = metadataItem.querySelector(
                "[name^='recipients'][name$='[fieldName]']"
              );
              const fieldValueInput = metadataItem.querySelector(
                "[name^='recipients'][name$='[fieldValue]']"
              );

              if (!fieldNameInput.value.trim()) {
                recErrs.push(`Metadata Field Name ${metadataIndex + 1}`);
                fieldNameInput.classList.add("is-invalid");
              } else {
                fieldNameInput.classList.remove("is-invalid");
              }

              if (!fieldValueInput.value.trim()) {
                recErrs.push(`Metadata Field Value ${metadataIndex + 1}`);
                fieldValueInput.classList.add("is-invalid");
              } else {
                fieldValueInput.classList.remove("is-invalid");
              }
            });

            if (recErrs.length > 0) {
              errors.push({ recipientIndex: index + 1, fields: recErrs });
            }
          });

          return errors;
        }

        function createDynamicErrorMessage(errors) {
          document.getElementById("loader").classList.add("hidden");
          let errorMessage = `
        <p><strong>Please address the following issues before proceeding:</strong></p>
        <ul>`;
          errors.forEach((error) => {
            const recipientNumber = error.recipientIndex;
            const invalidFields = error.fields
              .map((field) => `<li>${field}</li>`)
              .join("");
            errorMessage += `
          <li>
            <strong>Recipient ${recipientNumber}:</strong>
            <ul>${invalidFields}</ul>
          </li>`;
          });
          errorMessage += "</ul>";
          return errorMessage;
        }
      });
    </script>
  </body>
</html>
