<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Initiate Deposit</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f4f4f9;
        margin: 0;
        padding: 0;
        height: 100vh;
        opacity: 0;
        /* Initially hide the body */
        transition: opacity 0.5s ease-in-out;
        /* Smooth transition when showing */
      }

      .container {
        padding-top: 50px;
        transition: all 0.5s ease-in-out;
        /* Smooth transition */
      }

      h1 {
        color: #333;
        position: relative;
        font-size: 2.5rem;
        animation: fadeInDown 1s ease;
      }

      form {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        /* Center the form */
        transition: transform 0.3s ease;
      }

      .progress-bar {
        counter-reset: step;
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        padding-left: 0;
      }

      .progress-bar li {
        list-style: none;
        text-align: center;
        position: relative;
        flex-grow: 1;
        padding: 10px;
        color: #999;
        border-bottom: 3px solid #ccc;
        transition: color 0.4s ease, border-bottom-color 0.4s ease;
      }

      .progress-bar li::before {
        content: counter(step);
        counter-increment: step;
        width: 30px;
        height: 30px;
        display: block;
        background-color: #ccc;
        border-radius: 50%;
        margin: 0 auto 10px;
        line-height: 30px;
        transition: background-color 0.4s ease;
      }

      .progress-bar li.active {
        color: #28a745;
        border-bottom-color: #28a745;
      }

      .progress-bar li.active::before {
        background-color: #28a745;
      }

      .step {
        display: none;
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      .step.active {
        display: block;
        transform: scale(1);
        opacity: 1;
      }

      /* Operator card container to prevent overflow */
      .operator-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 10px;
      }

      .operator-card {
        padding: 1rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        text-align: center;
        width: 120px;
        /* Ensuring that the cards stay a consistent size */
        position: relative;
        transition: transform 0.3s ease, border-color 0.3s ease;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        flex: 1 1 120px;
        /* Flex-grow and flex-basis for responsiveness */
        max-width: 150px;
      }

      .operator-card img {
        width: 80px;
        height: auto;
        margin-bottom: 10px;
      }

      .operator-card:hover {
        cursor: pointer;
        transform: translateY(-5px);
        border-color: #007bff;
      }

      .operator-card.selected {
        border-color: #007bff;
        background-color: rgba(0, 123, 255, 0.1);
      }

      .operator-card.disabled {
        border-color: #ddd;
        opacity: 0.6;
        pointer-events: none;
      }

      .operator-card.disabled::before {
        content: "Not available";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: #888;
      }

      .operator-card.disabled {
        pointer-events: none;
        /* Make the card unclickable */
        opacity: 0.6;
        /* Dim the appearance */
      }

      .unavailable-text {
        color: red;
        font-size: 0.9em;
      }

      button {
        background-color: #0056b3;
        border: none;
        position: relative;
        overflow: hidden;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #004085;
      }

      button::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 300%;
        height: 300%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%) scale(0);
        transition: transform 0.5s ease;
        border-radius: 50%;
      }

      button:active::after {
        transform: translate(-50%, -50%) scale(1);
      }

      .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.4);
      }

      .form-control.is-invalid {
        border-color: #dc3545;
        animation: shake 0.3s ease;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }

        25% {
          transform: translateX(-10px);
        }

        50% {
          transform: translateX(10px);
        }

        75% {
          transform: translateX(-10px);
        }
      }

      .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }

      .form-control.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
      }

      .form-control.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
      }

      .form-error {
        display: none;
        color: red;
      }

      /* Responsive behavior */
      @media (max-width: 800px) {
        .operator-card {
          width: calc(50% - 20px);
          /* Two cards per row on smaller screens */
        }
      }

      @media (max-width: 500px) {
        .operator-card {
          width: calc(100% - 20px);
          /* One card per row on extra-small screens */
        }
      }

      @keyframes fadeInDown {
        0% {
          opacity: 0;
          transform: translateY(-20px);
        }

        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .list-group-item {
        font-size: 1.1rem;
      }

      .list-group-item strong {
        display: inline-block;
        width: 150px;
      }

      .powered-by-container {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .powered-by-text {
        font-size: 1rem;
        color: #555;
        margin-right: 8px;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      .pawapay-logo {
        max-width: 120px;
        height: auto;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      /* Hover effect to enhance the "ghosty" feel */
      .powered-by-text,
      .pawapay-logo {
        opacity: 0.5;
      }

      .powered-by-container:hover .powered-by-text,
      .powered-by-container:hover .pawapay-logo {
        filter: drop-shadow(0 0 8px rgba(0, 0, 0, 0.2));
      }

      .powered-by-container {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0) 0%,
          rgba(230, 230, 230, 0.5) 50%,
          rgba(255, 255, 255, 0) 100%
        );
        padding: 10px;
        border-radius: 5px;
      }

      .powered-by-text {
        font-size: 1rem;
        color: #333;
        margin-right: 8px;

        letter-spacing: 1px;
      }

      @media (max-width: 600px) {
        .pawapay-logo {
          max-width: 100px;
        }
      }

      /* Pro look for USSD quick links inside the modal */
      .ussd-link {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        border: 1px solid rgba(0, 0, 0, 0.12);
        border-radius: 0.375rem;
        background: linear-gradient(180deg, #fff, #f8f9fa);
        text-decoration: none;
        color: inherit;
      }
      .ussd-link:hover {
        background: #f1f3f5;
        text-decoration: none;
      }
      #mnoPinInstructions ol {
        padding-left: 1.2rem;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>

  <body>
    <!-- Preloader -->
    <div class="preloader">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <div
      class="container d-flex flex-column align-items-center justify-content-center"
    >
      <h1>Initiate Deposit</h1>
      <ul class="progress-bar">
        <li class="active">Country</li>
        <li>Mobile Network Operator</li>
        <li>Your Details</li>
        <li>Confirmation</li>
      </ul>

      <form id="depositForm" class="w-100">
        <!-- Step 1: Select Country -->
        <div class="step active" id="step-1">
          <div class="mb-3">
            <label for="country" class="form-label">Country:</label>
            <select id="country" name="country" required class="form-select">
              <option value="" disabled selected>Choose Country</option>
              <option value="Benin" data-currency="XOF">Benin</option>
              <option value="Burkina Faso" data-currency="XOF">
                Burkina Faso
              </option>
              <option value="Cameroon" data-currency="XAF">Cameroon</option>
              <option value="Congo" data-currency="XAF">
                Congo-Brazzaville
              </option>
              <option value="Congo (DRC)" data-currency="CDF">
                Congo-Kinshasa (CDF)
              </option>
              <option value="Congo (DRC)" data-currency="USD">
                Congo-Kinshasa (USD)
              </option>
              <option value="Cote D'Ivoire" data-currency="XOF">
                Cote D'Ivoire
              </option>
              <option value="Gabon" data-currency="XAF">Gabon</option>
              <option value="Ghana" data-currency="GHS">Ghana</option>
              <option value="Kenya" data-currency="KES">Kenya</option>
              <option value="Malawi" data-currency="MWK">Malawi</option>
              <option value="Mozambique" data-currency="MZN">Mozambique</option>
              <option value="Nigeria" data-currency="NGN">Nigeria</option>
              <option value="Rwanda" data-currency="RWF">Rwanda</option>
              <option value="Senegal" data-currency="XOF">Senegal</option>
              <option value="Sierra Leone" data-currency="SLE">
                Sierra Leone
              </option>
              <option value="Uganda" data-currency="UGX">Uganda</option>
              <option value="Zambia" data-currency="ZMW">Zambia</option>
            </select>

            <div class="form-error" id="countryError">
              Please select a country.
            </div>
          </div>

          <div class="navigation-buttons">
            <button
              type="button"
              id="nextBtn"
              class="btn btn-primary w-100"
              onclick="validateCountry()"
            >
              Next
            </button>
          </div>
        </div>

        <!-- Step 2: Select MNO -->
        <div class="step" id="step-2">
          <label for="operator" class="form-label mb-3">Operator</label>
          <!-- Error message div, initially hidden -->
          <!-- Bootstrap styled error message div, initially hidden -->
          <div
            id="mnoError"
            class="alert alert-danger"
            role="alert"
            style="display: none"
          >
            Please select a mobile network operator.
          </div>
          <div
            id="mno-cards-container"
            class="operator-container d-flex justify-content-between"
          >
            <!-- MNO cards dynamically generated here -->
          </div>
          <input type="hidden" id="selectedMno" name="mno" />

          <div class="navigation-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="prevStep()"
            >
              Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Next
            </button>
          </div>
        </div>

        <!-- Step 3: Enter Details -->
        <div class="step" id="step-3">
          <div class="mb-3">
            <label for="amount" class="form-label">Amount:</label>
            <div class="input-group has-validation">
              <span class="input-group-text" id="currency"></span>
              <input
                type="text"
                id="amount"
                name="amount"
                class="form-control"
                placeholder="Amount"
                aria-label="Amount"
                aria-describedby="currency"
                required
              />
              <div id="amountError" class="invalid-feedback">
                Please enter a valid amount.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="payerMsisdn" class="form-label"
              >Payer's Phone Number:</label
            >
            <div class="input-group has-validation">
              <span class="input-group-text">
                <img
                  id="countryFlag"
                  src="flags/ug.png"
                  alt="Flag"
                  width="24"
                  height="16"
                  class="me-2"
                />
                <span id="countryCode">+256</span>
              </span>
              <input
                type="text"
                id="payerMsisdn"
                name="payerMsisdn"
                class="form-control"
                placeholder="Phone Number"
                aria-label="Phone Number"
                aria-describedby="countryCode"
                required
              />
              <div id="payerMsisdnError" class="invalid-feedback">
                Please enter a valid phone number.
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description:</label>
            <input
              type="text"
              id="description"
              name="description"
              class="form-control"
              placeholder="Enter description"
              maxlength="22"
              required
            />
            <div id="descriptionError" class="invalid-feedback">
              Description must be up to 22 alphanumeric characters and spaces.
            </div>
          </div>

          <div class="navigation-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="prevStep()"
            >
              Previous
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Next
            </button>
          </div>
        </div>

        <!-- Step 4: Confirmation -->
        <div class="step" id="step-4">
          <p>Review your details and confirm.</p>
          <!-- Display summary of the entered data -->
          <div id="confirmationSummary" class="mb-4">
            <!-- We'll populate this div with the summary -->
          </div>

          <div class="navigation-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="prevStep()"
            >
              Previous
            </button>
            <!-- Change the button type to 'button' and remove the onclick attribute -->
            <button
              type="button"
              id="submitBtn"
              class="btn btn-success"
              onclick="openPaymentModal()"
            >
              Confirm
            </button>
          </div>
        </div>
      </form>

      <!-- Powered by Pawapay Logo -->
      <div class="powered-by-container text-center mt-4">
        <span class="powered-by-text">Powered by</span>
        <img
          src="images/powered_by_pawapay.png"
          alt="Pawapay Logo"
          class="pawapay-logo"
        />
      </div>

      <!-- Bootstrap Modal -->
      <div
        class="modal fade"
        id="paymentModal"
        tabindex="-1"
        aria-labelledby="paymentModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="paymentModalLabel">
                Confirm Payment
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Payment details will be inserted here -->
              <div id="paymentDetails">
                <p>
                  You are about to pay <strong id="modalAmount"></strong> using
                  your phone number <strong id="modalPhoneNumber"></strong>.
                </p>
                <p>
                  Please complete the payment by authorizing the transaction on
                  your phone. Enter your PIN code when prompted to finalize the
                  payment.
                </p>
                
                <!--  v2 per-MNO instructions get injected here -->
                <div
                  id="mnoPinInstructions"
                  class="alert alert-secondary mt-2"
                  style="display: none"
                ></div>

                <p>Do you wish to proceed?</p>
              </div>

              <div
                id="loadingSpinner"
                class="text-center"
                style="display: none"
              >
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Processing...</span>
                </div>
                <p>Processing your payment...</p>
              </div>
              <!-- Error Message -->
              <div id="errorMessage" style="display: none">
                <!-- Error messages will be displayed here -->
              </div>

              <!-- Success Message -->
              <div id="successMessage" style="display: none">
                <!-- Success messages will be displayed here -->
              </div>
            </div>

            <div
              class="modal-footer d-flex justify-content-between align-items-center"
            >
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="button" class="btn btn-success" id="payBtn">
                Pay
              </button>
            </div>
            <!-- Powered by Pawapay Logo -->
            <div class="powered-by-container text-center mt-3">
              <span class="powered-by-text">Powered by</span>
              <img
                src="images/powered_by_pawapay.png"
                alt="Pawapay Logo"
                class="pawapay-logo"
              />
            </div>
          </div>
        </div>
      </div>

      <div id="result" class="mt-3 text-center"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/libphonenumber-js@1.10.22/bundle/libphonenumber-max.js"></script>

    <script>
      /* ===========================
       * Version-aware config loader
       * =========================== */
      const confVersion = "v1";
      window.confVersion = confVersion;

      // expose where we stash v2 extras
      window.__countryMeta = {};
      window.__pinInstructions = {};
      window.__activeConfVersion = null;

      // Unified selector: URL > global > localStorage > 'auto'
      (function () {
        const qs = new URLSearchParams(location.search);
        const fromUrl = (qs.get("confVersion") || "").toLowerCase();
        const fromGlob =
          (typeof globalThis.confVersion === "string" &&
            globalThis.confVersion.toLowerCase()) ||
          null;
        const fromLocal = (
          localStorage.getItem("confVersion") || ""
        ).toLowerCase();
        const valid = (v) => ["v1", "v2", "auto"].includes(v);

        const chosen =
          (valid(fromUrl) && fromUrl) ||
          (valid(fromGlob) && fromGlob) ||
          (valid(fromLocal) && fromLocal) ||
          "auto";

        window.CONFIG_VERSION = chosen;
        window.setConfVersion = (v) => {
          const val = (v || "auto").toLowerCase();
          localStorage.setItem("confVersion", val);
          window.confVersion = val;
          location.reload();
        };

        console.debug("[conf] CONFIG_VERSION =", chosen);
      })();

      function candidateFiles(kind) {
        const byKind = {
          active: {
            v2: ["../data/active_conf_v2.json"],
            v1: ["../data/active_conf.json", "../data/active_conf_v1.json"],
            auto: [
              "../data/active_conf_v2.json",
              "../data/active_conf.json",
              "../data/active_conf_v1.json",
            ],
          },
          availability: {
            v2: ["../data/mno_availability_v2.json"],
            v1: [
              "../data/mno_availability.json",
              "../data/mno_availability_v1.json",
            ],
            auto: [
              "../data/mno_availability_v2.json",
              "../data/mno_availability.json",
              "../data/mno_availability_v1.json",
            ],
          },
        };
        const mode = window.CONFIG_VERSION || "auto";
        return byKind[kind][mode] || byKind[kind].auto;
      }

      async function fetchFirstAvailable(urls) {
        for (const u of urls) {
          try {
            const res = await fetch(u, { cache: "no-cache" });
            if (res.ok) return { url: u, data: await res.json() };
          } catch (_) {}
        }
        return { url: null, data: null };
      }

      const COUNTRY_TO_ISO3 = {
        Algeria: "DZA",
        Angola: "AGO",
        Benin: "BEN",
        Botswana: "BWA",
        "Burkina Faso": "BFA",
        Burundi: "BDI",
        "Cabo Verde": "CPV",
        Cameroon: "CMR",
        "Central African Republic": "CAF",
        Chad: "TCD",
        Comoros: "COM",
        Congo: "COG",
        "Congo (DRC)": "COD",
        "Cote D'Ivoire": "CIV",
        Djibouti: "DJI",
        Egypt: "EGY",
        "Equatorial Guinea": "GNQ",
        Eritrea: "ERI",
        Eswatini: "SWZ",
        Ethiopia: "ETH",
        Gabon: "GAB",
        Gambia: "GMB",
        Ghana: "GHA",
        Guinea: "GIN",
        "Guinea-Bissau": "GNB",
        Kenya: "KEN",
        Lesotho: "LSO",
        Liberia: "LBR",
        Libya: "LBY",
        Madagascar: "MDG",
        Malawi: "MWI",
        Mali: "MLI",
        Mauritania: "MRT",
        Mauritius: "MUS",
        Morocco: "MAR",
        Mozambique: "MOZ",
        Namibia: "NAM",
        Niger: "NER",
        Nigeria: "NGA",
        Rwanda: "RWA",
        "Sao Tome and Principe": "STP",
        Senegal: "SEN",
        Seychelles: "SYC",
        "Sierra Leone": "SLE",
        Somalia: "SOM",
        "South Africa": "ZAF",
        "South Sudan": "SSD",
        Sudan: "SDN",
        Tanzania: "TZA",
        Togo: "TGO",
        Tunisia: "TUN",
        Uganda: "UGA",
        Zambia: "ZMB",
        Zimbabwe: "ZWE",
      };

      // Normalize active_conf (supports v1 & v2)
      function normalizeActiveConf(raw) {
        const ownerNameMap = {};
        const logoMap = {};
        const countryMeta = {};
        const pinInstructionsMap = {}; // NEW: providerCode -> string
        let version = null;

        if (!raw || !raw.countries) {
          return {
            ownerNameMap,
            logoMap,
            countryMeta,
            pinInstructionsMap,
            version,
          };
        }

        // v2: countries[].providers[], plus country prefix/flag, and per-MNO instructions
        if (raw.countries[0]?.providers) {
          version = "v2";
          raw.countries.forEach((c) => {
            if (c.country) {
              countryMeta[c.country] = {
                prefix: c.prefix
                  ? `+${String(c.prefix).replace(/^\+/, "")}`
                  : null,
                flag: c.flag || null,
              };
            }
            (c.providers || []).forEach((p) => {
              const code = p.provider;
              if (!code) return;
              ownerNameMap[code] =
                p.nameDisplayedToCustomer || p.displayName || code;
              if (p.logo) logoMap[code] = p.logo;

              // pull instructions if present (v2 nests this under currencies[].operationTypes.DEPOSIT)
              let instr = null;
              (p.currencies || []).forEach((cur) => {
                const dep =
                  cur && cur.operationTypes && cur.operationTypes.DEPOSIT;
                if (dep && dep.pinPromptInstructions && !instr) {
                  instr = dep.pinPromptInstructions;
                }
              });

              if (typeof instr === "string" && instr.trim()) {
                pinInstructionsMap[code] = instr.trim();
              } else if (instr && typeof instr === "object") {
                // keep the full structured object; we'll render it later
                pinInstructionsMap[code] = instr;
              }
            });
          });
          return {
            ownerNameMap,
            logoMap,
            countryMeta,
            pinInstructionsMap,
            version,
          };
        }

        // v1/legacy
        version = "v1";
        raw.countries.forEach((c) => {
          (c.correspondents || []).forEach((co) => {
            const code = co.correspondent;
            if (!code) return;
            ownerNameMap[code] = co.ownerName || code;
          });
        });
        return {
          ownerNameMap,
          logoMap,
          countryMeta,
          pinInstructionsMap,
          version,
        };
      }

      // Normalize availability (supports v1 & v2, both shapes)
      function normalizeAvailability(raw) {
        const availabilityMap = {};
        if (!raw) return availabilityMap;

        const mark = (code, ops) => {
          const ok = Array.isArray(ops)
            ? ops.every((o) => o && o.status === "OPERATIONAL") // v1
            : Object.values(ops || {}).every((s) => s === "OPERATIONAL"); // v2
          availabilityMap[code] = ok;
        };

        if (Array.isArray(raw) && raw[0]?.providers) {
          raw.forEach((c) =>
            (c.providers || []).forEach((p) =>
              mark(p.provider, p.operationTypes)
            )
          );
          return availabilityMap;
        }

        if (raw?.countries && Array.isArray(raw.countries)) {
          raw.countries.forEach((c) =>
            (c.providers || []).forEach((p) =>
              mark(p.provider, p.operationTypes)
            )
          );
          return availabilityMap;
        }

        (raw || []).forEach((c) =>
          (c.correspondents || []).forEach((co) =>
            mark(co.correspondent, co.operationTypes)
          )
        );

        return availabilityMap;
      }

      // =======  static model  =======
      const mnoCorrespondents = {
        Benin: [
          {
            name: "MTN Benin",
            apiCode: "MTN_MOMO_BEN",
            countryCode: "+229",
            flag: "bj.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Moov Benin",
            apiCode: "MOOV_BEN",
            countryCode: "+229",
            flag: "bj.png",
            available: false,
            img: "moov.png",
          },
        ],
        "Burkina Faso": [
          {
            name: "Orange Burkina Faso",
            apiCode: "ORANGE_BFA",
            countryCode: "+226",
            flag: "bf.png",
            available: true,
            img: "orange-money-logo.jpg",
          },
          {
            name: "Moov Burkina Faso",
            apiCode: "MOOV_BFA",
            countryCode: "+226",
            flag: "bf.png",
            available: true,
            img: "moov.png",
          },
        ],
        Cameroon: [
          {
            name: "MTN Cameroon",
            apiCode: "MTN_MOMO_CMR",
            countryCode: "+237",
            flag: "cm.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Orange Cameroon",
            apiCode: "ORANGE_CMR",
            countryCode: "+237",
            flag: "cm.png",
            available: true,
            img: "orange-money-logo.jpg",
          },
        ],
        Congo: [
          // { name: "MTN Congo", apiCode: "MTN_MOMO_COG", countryCode: "+242", flag: "cg.png", available: true, img: "mtn.png" },
          {
            name: "Airtel Congo",
            apiCode: "AIRTEL_COG",
            countryCode: "+242",
            flag: "cg.png",
            available: false,
            img: "airtel.png",
          },
        ],
        "Congo (DRC)": [
          {
            name: "Vodacom DRC",
            apiCode: "VODACOM_MPESA_COD",
            countryCode: "+243",
            flag: "cd.png",
            available: true,
            img: "vodacom.jpg",
          },
          {
            name: "Airtel DRC",
            apiCode: "AIRTEL_COD",
            countryCode: "+243",
            flag: "cd.png",
            available: true,
            img: "airtel.png",
          },
          {
            name: "Orange DRC",
            apiCode: "ORANGE_COD",
            countryCode: "+243",
            flag: "cd.png",
            available: false,
            img: "orange-money-logo.jpg",
          },
        ],
        "Cote D'Ivoire": [
          {
            name: "MTN Cote d'Ivoire",
            apiCode: "MTN_MOMO_CIV",
            countryCode: "+225",
            flag: "ci.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Orange Cote d'Ivoire",
            apiCode: "ORANGE_CIV",
            countryCode: "+225",
            flag: "ci.png",
            available: true,
            img: "orange-money-logo.jpg",
          },
          {
            name: "Moov Cote d'Ivoire",
            apiCode: "MOOV_CIV",
            countryCode: "+225",
            flag: "ci.png",
            available: true,
            img: "moov.png",
          },
          {
            name: "Wave Cote d'Ivoire",
            apiCode: "WAVE_CIV",
            countryCode: "+225",
            flag: "ci.png",
            available: true,
            img: "wave-logo.png",
          },
        ],
        Gabon: [
          {
            name: "Airtel Gabon",
            apiCode: "AIRTEL_GAB",
            countryCode: "+241",
            flag: "ga.png",
            available: true,
            img: "airtel.png",
          },
          {
            name: "Moov Gabon",
            apiCode: "MOOV_GAB",
            countryCode: "+241",
            flag: "ga.png",
            available: true,
            img: "moov.png",
          },
        ],
        Ghana: [
          {
            name: "MTN Ghana",
            apiCode: "MTN_MOMO_GHA",
            countryCode: "+233",
            flag: "gh.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "AirtelTigo Ghana",
            apiCode: "AIRTELTIGO_GHA",
            countryCode: "+233",
            flag: "gh.png",
            available: true,
            img: "airtel-tigo.png",
          },
          {
            name: "Vodafone Ghana",
            apiCode: "VODAFONE_GHA",
            countryCode: "+233",
            flag: "gh.png",
            available: true,
            img: "vodacom.jpg",
          },
        ],
        Kenya: [
          {
            name: "Safaricom Kenya",
            apiCode: "MPESA_KEN",
            countryCode: "+254",
            flag: "ke.png",
            available: true,
            img: "safaricom-logo.png",
          },
          {
            name: "Airtel Kenya",
            apiCode: "AIRTEL_KEN",
            countryCode: "+254",
            flag: "ke.png",
            available: true,
            img: "airtel.png",
          },
        ],
        Malawi: [
          {
            name: "Airtel Malawi",
            apiCode: "AIRTEL_MWI",
            countryCode: "+265",
            flag: "mw.png",
            available: true,
            img: "airtel.png",
          },
          {
            name: "TNM Malawi",
            apiCode: "TNM_MWI",
            countryCode: "+265",
            flag: "mw.png",
            available: true,
            img: "mw-tnm-logo.png",
          },
        ],
        Mozambique: [
          {
            name: "Vodacom Mozambique",
            apiCode: "VODACOM_MOZ",
            countryCode: "+258",
            flag: "mz.png",
            available: true,
            img: "vodacom.jpg",
          },
          {
            name: "Movitel Mozambique",
            apiCode: "MOVITEL_MOZ",
            countryCode: "+258",
            flag: "mz.png",
            available: true,
            img: "movitel.png",
          },
        ],
        Nigeria: [
          {
            name: "MTN Nigeria",
            apiCode: "MTN_MOMO_NGA",
            countryCode: "+234",
            flag: "ng.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Airtel Nigeria",
            apiCode: "AIRTEL_NGA",
            countryCode: "+234",
            flag: "ng.png",
            available: true,
            img: "airtel.png",
          },
        ],
        Rwanda: [
          {
            name: "MTN Rwanda",
            apiCode: "MTN_MOMO_RWA",
            countryCode: "+250",
            flag: "rw.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Airtel Rwanda",
            apiCode: "AIRTEL_RWA",
            countryCode: "+250",
            flag: "rw.png",
            available: true,
            img: "airtel.png",
          },
        ],
        Senegal: [
          {
            name: "Orange Senegal",
            apiCode: "ORANGE_SEN",
            countryCode: "+221",
            flag: "sn.png",
            available: true,
            img: "orange-money-logo.jpg",
          },
          {
            name: "Free Senegal",
            apiCode: "FREE_SEN",
            countryCode: "+221",
            flag: "sn.png",
            available: true,
            img: "free.png",
          },
        ],
        "Sierra Leone": [
          {
            name: "Orange Sierra Leone",
            apiCode: "ORANGE_SLE",
            countryCode: "+232",
            flag: "sl.png",
            available: true,
            img: "orange-money-logo.jpg",
          },
          {
            name: "Africell Sierra Leone",
            apiCode: "AFRICELL_SLE",
            countryCode: "+232",
            flag: "sl.png",
            available: true,
            img: "africell.png",
          },
        ],
        Tanzania: [
          {
            name: "Vodacom Tanzania",
            apiCode: "VODACOM_TZA",
            countryCode: "+255",
            flag: "tz.png",
            available: true,
            img: "vodacom.jpg",
          },
          {
            name: "Airtel Tanzania",
            apiCode: "AIRTEL_TZA",
            countryCode: "+255",
            flag: "tz.png",
            available: true,
            img: "airtel.png",
          },
          {
            name: "Tigo Tanzania",
            apiCode: "TIGO_TZA",
            countryCode: "+255",
            flag: "tz.png",
            available: true,
            img: "tigo-pesa-tanzania.png",
          },
          {
            name: "Halotel Tanzania",
            apiCode: "HALOTEL_TZA",
            countryCode: "+255",
            flag: "tz.png",
            available: true,
            img: "halotel-tz.png",
          },
        ],
        Uganda: [
          {
            name: "MTN Uganda",
            apiCode: "MTN_MOMO_UGA",
            countryCode: "+256",
            flag: "ug.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Airtel Uganda",
            apiCode: "AIRTEL_OAPI_UGA",
            countryCode: "+256",
            flag: "ug.png",
            available: true,
            img: "airtel.png",
          },
        ],
        Zambia: [
          {
            name: "MTN Zambia",
            apiCode: "MTN_MOMO_ZMB",
            countryCode: "+260",
            flag: "zm.png",
            available: true,
            img: "mtn.png",
          },
          {
            name: "Airtel Zambia",
            apiCode: "AIRTEL_OAPI_ZMB",
            countryCode: "+260",
            flag: "zm.png",
            available: true,
            img: "airtel.png",
          },
          {
            name: "Zamtel Zambia",
            apiCode: "ZAMTEL_ZMB",
            countryCode: "+260",
            flag: "zm.png",
            available: false,
            img: "zamtel-za.png",
          },
        ],
      };

      // Load availability + active config with version fallbacks
      async function loadAvailabilityData() {
        try {
          const [av, ac] = await Promise.all([
            fetchFirstAvailable(candidateFiles("availability")),
            fetchFirstAvailable(candidateFiles("active")),
          ]);

          if (!av.data && !ac.data)
            throw new Error("No config files could be loaded.");

          const activeNormalized = ac.data
            ? normalizeActiveConf(ac.data)
            : {
                ownerNameMap: {},
                logoMap: {},
                countryMeta: {},
                pinInstructionsMap: {},
                version: null,
              };

          const availabilityMap = av.data ? normalizeAvailability(av.data) : {};

          // stash v2 meta + instructions + version for later
          window.__countryMeta = activeNormalized.countryMeta || {};
          window.__pinInstructions = activeNormalized.pinInstructionsMap || {};
          window.__activeConfVersion = activeNormalized.version || null;

          return {
            availabilityData: availabilityMap,
            activeConfData: activeNormalized,
          };
        } catch (error) {
          console.error("Error loading availability data:", error);
          return null;
        }
      }

      // Update mnoCorrespondents availability/owner/logo using normalized or raw data
      function updateMnoAvailability(availabilityData, activeConfData) {
        if (!availabilityData || !activeConfData) {
          console.error(
            "No availability or active configuration data to process."
          );
          return;
        }

        const availabilityMap =
          Array.isArray(availabilityData) || availabilityData.countries
            ? normalizeAvailability(availabilityData)
            : availabilityData;

        let ownerNameMap = {};
        let logoMap = {};
        let countryMeta = {};
        let pinInstructionsMap = {};
        let version = null;

        if (activeConfData.ownerNameMap) {
          ownerNameMap = activeConfData.ownerNameMap;
          logoMap = activeConfData.logoMap || {};
          countryMeta = activeConfData.countryMeta || {};
          pinInstructionsMap = activeConfData.pinInstructionsMap || {};
          version = activeConfData.version || null;
        } else {
          const normalized = normalizeActiveConf(activeConfData);
          ownerNameMap = normalized.ownerNameMap;
          logoMap = normalized.logoMap || {};
          countryMeta = normalized.countryMeta || {};
          pinInstructionsMap = normalized.pinInstructionsMap || {};
          version = normalized.version || null;
        }

        // refresh globals
        window.__countryMeta = countryMeta || {};
        window.__pinInstructions = pinInstructionsMap || {};
        window.__activeConfVersion = version;

        // Apply to static model
        for (const country in mnoCorrespondents) {
          mnoCorrespondents[country].forEach((mno) => {
            const apiCode = mno.apiCode;

            // 1) Availability
            if (
              Object.prototype.hasOwnProperty.call(availabilityMap, apiCode)
            ) {
              mno.available = !!availabilityMap[apiCode];
            } else {
              mno.available = false;
            }

            // 2) Owner name
            mno.ownerName = ownerNameMap[apiCode] || "N/A";

            // 3) Logo
            if (logoMap[apiCode]) {
              mno.logoUrl = logoMap[apiCode];
            }
          });
        }
      }

      // ---------------- existing UI logic  ----------------
      let currentStep = 0;
      showStep(currentStep);

      function showStep(n) {
        const steps = document.getElementsByClassName("step");
        steps[n].classList.add("active");

        const progressBar = document.querySelectorAll(".progress-bar li");
        progressBar.forEach((li, index) => {
          if (index <= n) li.classList.add("active");
          else li.classList.remove("active");
        });

        if (n === 3) updateConfirmation();
      }

      function updateConfirmation() {
        const countrySelect = document.getElementById("country");
        const country =
          countrySelect.options[countrySelect.selectedIndex].value;
        const selectedMnoCode = document.getElementById("selectedMno").value;

        let selectedMnoName = "";
        let ownerName = "";
        const mnos = mnoCorrespondents[country];
        if (mnos) {
          for (let i = 0; i < mnos.length; i++) {
            if (mnos[i].apiCode === selectedMnoCode) {
              selectedMnoName = mnos[i].name;
              ownerName = mnos[i].ownerName || "N/A";
              break;
            }
          }
        }

        const amount = document.getElementById("amount").value;
        const currency =
          countrySelect.options[countrySelect.selectedIndex].getAttribute(
            "data-currency"
          );
        const countryCode = document.getElementById("countryCode").textContent;
        const phoneNumber = document.getElementById("payerMsisdn").value;
        const description = document.getElementById("description").value;

        const summaryHTML = `
          <ul class="list-group">
            <li class="list-group-item"><strong>Country:</strong> ${country}</li>
            <li class="list-group-item"><strong>Operator:</strong> ${selectedMnoName}</li>
            <li class="list-group-item"><strong>Pay Request From:</strong> ${ownerName}</li>
            <li class="list-group-item"><strong>Amount:</strong> ${currency} ${amount}</li>
            <li class="list-group-item"><strong>Phone Number:</strong> ${countryCode}${phoneNumber}</li>
            <li class="list-group-item"><strong>Description:</strong> ${description}</li>
          </ul>
        `;

        const noticeMessage = `
          <div class="alert alert-info mt-4" role="alert">
            <strong>Important:</strong> You will receive a payment request from <strong>${ownerName}</strong> acting on behalf of <strong>Katorymnd Freelancer</strong>. Please confirm the payment to proceed with your transaction.
          </div>
        `;

        document.getElementById("confirmationSummary").innerHTML =
          noticeMessage + summaryHTML;
      }

      function nextStep() {
        const steps = document.getElementsByClassName("step");

        if (currentStep === 1) {
          const selectedMno = document.getElementById("selectedMno").value;
          const errorDiv = document.getElementById("mnoError");
          if (!selectedMno) {
            errorDiv.style.display = "block";
            return;
          } else {
            errorDiv.style.display = "none";
          }
        }

        if (currentStep === 2) {
          validateAmountInput();
          const amountInput = document.getElementById("amount");

          validatePhoneNumber();
          const msisdnInput = document.getElementById("payerMsisdn");

          validateDescriptionInput();
          const descriptionInput = document.getElementById("description");

          if (
            amountInput.classList.contains("is-invalid") ||
            msisdnInput.classList.contains("is-invalid") ||
            descriptionInput.classList.contains("is-invalid")
          ) {
            return;
          }
        }

        if (currentStep < steps.length - 1) {
          steps[currentStep].classList.remove("active");
          currentStep++;
          showStep(currentStep);
        }
      }

      function validateAmountInput() {
        const amountInput = document.getElementById("amount");
        let amountValue = amountInput.value.trim();
        amountValue = amountValue.replace(/[^\d.]/g, "");
        amountInput.value = amountValue;
        let amountNumber = parseFloat(amountValue);

        if (isNaN(amountNumber) || amountNumber <= 0) {
          amountInput.classList.add("is-invalid");
          amountInput.classList.remove("is-valid");
        } else {
          amountNumber = Math.round(amountNumber);
          amountInput.value = amountNumber;
          amountInput.classList.remove("is-invalid");
          amountInput.classList.add("is-valid");
        }
      }

      function validatePhoneNumber() {
        const phoneInput = document.getElementById("payerMsisdn");
        const phoneErrorDiv = document.getElementById("payerMsisdnError");
        const countryCodeSpan = document.getElementById("countryCode");
        let phoneNumber = phoneInput.value.trim();
        const countryCode = countryCodeSpan.textContent.trim().replace("+", "");
        phoneNumber = phoneNumber.replace(/\s+/g, "");
        const fullNumber = `+${countryCode}${phoneNumber}`;

        try {
          const phoneNumberInstance =
            libphonenumber.parsePhoneNumber(fullNumber);
          if (phoneNumberInstance.isValid()) {
            phoneInput.classList.remove("is-invalid");
            phoneInput.classList.add("is-valid");
            phoneErrorDiv.style.display = "none";
          } else {
            phoneInput.classList.add("is-invalid");
            phoneInput.classList.remove("is-valid");
            phoneErrorDiv.textContent = "Please enter a valid phone number.";
            phoneErrorDiv.style.display = "block";
          }
        } catch (error) {
          phoneInput.classList.add("is-invalid");
          phoneInput.classList.remove("is-valid");
          phoneErrorDiv.textContent = "Please enter a valid phone number.";
          phoneErrorDiv.style.display = "block";
        }
      }

      function validateDescriptionInput() {
        const descriptionInput = document.getElementById("description");
        const descriptionErrorDiv = document.getElementById("descriptionError");
        let descriptionValue = descriptionInput.value;
        const validDescription = descriptionValue.replace(/[^a-zA-Z0-9 ]/g, "");

        if (descriptionValue !== validDescription) {
          descriptionInput.value = validDescription;
          descriptionValue = validDescription;
        }

        if (descriptionValue.trim() === "") {
          descriptionInput.classList.add("is-invalid");
          descriptionInput.classList.remove("is-valid");
          descriptionErrorDiv.style.display = "block";
          descriptionErrorDiv.textContent = "Description cannot be empty.";
        } else {
          descriptionInput.classList.remove("is-invalid");
          descriptionInput.classList.add("is-valid");
          descriptionErrorDiv.style.display = "none";
        }
      }

      document
        .getElementById("description")
        .addEventListener("input", validateDescriptionInput);
      document
        .getElementById("payerMsisdn")
        .addEventListener("input", validatePhoneNumber);
      document
        .getElementById("amount")
        .addEventListener("input", validateAmountInput);

      function prevStep() {
        const steps = document.getElementsByClassName("step");
        if (currentStep > 0) {
          steps[currentStep].classList.remove("active");
          currentStep--;
          showStep(currentStep);
        }
      }

      document
        .getElementById("country")
        .addEventListener("change", function () {
          const selectedOption = this.options[this.selectedIndex];
          const country = selectedOption.value;
          const currency = selectedOption.getAttribute("data-currency");

          document.getElementById("selectedMno").value = "";
          localStorage.removeItem("selectedMno");
          localStorage.setItem("selectedCountry", country);

          document.getElementById("currency").textContent = currency;

          const correspondents = mnoCorrespondents[country];
          if (correspondents && correspondents.length > 0) {
            const countryCode = correspondents[0].countryCode;
            const flag = correspondents[0].flag;
            document.getElementById("countryCode").textContent = countryCode;
            document.getElementById("countryFlag").src = "flags/" + flag;
            document.getElementById("countryFlag").alt = country + " flag";
          } else {
            document.getElementById("countryCode").textContent = "+000";
            document.getElementById("countryFlag").src = "flags/default.png";
            document.getElementById("countryFlag").alt = "default flag";
          }

          if (correspondents) {
            displayMnoCards(correspondents);
          } else {
            document.getElementById("mno-cards-container").innerHTML =
              "No MNO available for this country";
          }

          updateStep3Details(country, currency, correspondents);
        });

      function updateStep3Details(country, currency, correspondents) {
        document.getElementById("currency").textContent = currency;

        const iso3 = COUNTRY_TO_ISO3[country];
        const meta =
          iso3 && window.__countryMeta ? window.__countryMeta[iso3] : null;

        if (meta && (meta.prefix || meta.flag)) {
          if (meta.prefix)
            document.getElementById("countryCode").textContent = meta.prefix;
          if (meta.flag) {
            document.getElementById("countryFlag").src = meta.flag;
            document.getElementById("countryFlag").alt = country + " flag";
          }
          return;
        }

        if (correspondents && correspondents.length > 0) {
          const countryCode = correspondents[0].countryCode;
          const flag = correspondents[0].flag;
          document.getElementById("countryCode").textContent = countryCode;
          document.getElementById("countryFlag").src = "flags/" + flag;
          document.getElementById("countryFlag").alt = country + " flag";
        }
      }

      function displayMnoCards(mnos) {
        const container = document.getElementById("mno-cards-container");
        container.innerHTML = "";

        document.getElementById("selectedMno").value = "";

        mnos.forEach((mno) => {
          const card = document.createElement("div");
          card.className = `operator-card ${mno.available ? "" : "disabled"}`;

          card.innerHTML = `
            <img src="${
              mno.logoUrl ? mno.logoUrl : "mno-img/" + mno.img
            }" alt="${mno.name}" />
            <p>${mno.name}</p>
            ${
              mno.available
                ? ""
                : '<span class="unavailable-text">Not available</span>'
            }
          `;

          card.onclick = function () {
            if (mno.available) {
              document
                .querySelectorAll(".operator-card")
                .forEach((c) => c.classList.remove("selected"));
              card.classList.add("selected");
              document.getElementById("selectedMno").value = mno.apiCode;
              localStorage.setItem("selectedMno", mno.apiCode);

              const errorDiv = document.getElementById("mnoError");
              if (errorDiv) errorDiv.style.display = "none";
            }
          };

          container.appendChild(card);
        });

        const preselectedMno = localStorage.getItem("selectedMno");
        if (preselectedMno) {
          document.querySelectorAll(".operator-card").forEach((c) => {
            if (c.querySelector("p").textContent.includes(preselectedMno)) {
              c.classList.add("selected");
              document.getElementById("selectedMno").value = preselectedMno;
            }
          });
        } else {
          document.getElementById("selectedMno").value = "";
        }
      }

      function applyVars(tpl, vars) {
        if (!tpl) return "";
        return tpl.replace(/{{\s*([\w]+)\s*}}/g, (_, k) =>
          vars && k in vars ? String(vars[k]) : `{{${k}}}`
        );
      }

      function _normWS(s) {
        return (s || "").replace(/\s+/g, " ").trim();
      }
      function _canonStep(s) {
        // normalize to compare: trim, collapse ws, make 'pin' uniform, lowercase
        return _normWS(s)
          .replace(/\bpin\b/gi, "pin")
          .toLowerCase();
      }

      // Turn the v2 pinPromptInstructions object into HTML (EN/FR)
      function renderPinInstructions(pinObj, lang) {
        try {
          const channels = Array.isArray(pinObj?.channels)
            ? pinObj.channels
            : [];
          const chosenLang = (
            lang ||
            document.documentElement.getAttribute("lang") ||
            "en"
          ).slice(0, 2);

          const seenChannels = new Set();
          const blocks = [];

          for (const ch of channels) {
            const title =
              (ch.displayName &&
                (ch.displayName[chosenLang] || ch.displayName.en)) ||
              "";
            const vars = ch.variables || {};
            const srcSteps =
              (ch.instructions &&
                (ch.instructions[chosenLang] || ch.instructions.en)) ||
              [];
            const quick = ch.quickLink ? _normWS(ch.quickLink) : "";

            // Dedupe steps within a channel
            const stepSeen = new Set();
            const renderedSteps = [];
            for (const s of srcSteps) {
              const raw = s.template
                ? applyVars(s.template, vars)
                : s.text || "";
              const norm = _canonStep(raw);
              if (!norm || stepSeen.has(norm)) continue;
              stepSeen.add(norm);
              renderedSteps.push(`<li>${_normWS(raw)}</li>`);
            }

            if (!renderedSteps.length) continue;

            // Dedupe whole channels (same type/title/quickLink/steps)
            const sig = JSON.stringify({
              type: String(ch.type || "").toLowerCase(),
              title: _normWS(title).toLowerCase(),
              quick: quick.toLowerCase(),
              steps: Array.from(stepSeen).join("|"),
            });
            if (seenChannels.has(sig)) continue;
            seenChannels.add(sig);

            blocks.push(`
        <div class="mb-2">
          ${title ? `<div class="fw-semibold">${title}</div>` : ""}
          ${
            quick
              ? `<div class="small mb-1"><a class="ussd-link" href="tel:${quick}">${quick}</a></div>`
              : ""
          }
          <ol class="mb-0">${renderedSteps.join("")}</ol>
        </div>
      `);
          }

          return blocks.join("") || null;
        } catch (_) {
          return null;
        }
      }

      function openPaymentModal() {
        const amount = document.getElementById("amount").value;
        const countrySelect = document.getElementById("country");
        const currency =
          countrySelect.options[countrySelect.selectedIndex].getAttribute(
            "data-currency"
          );
        const countryCode = document.getElementById("countryCode").textContent;
        const phoneNumber = document.getElementById("payerMsisdn").value;

        document.getElementById(
          "modalAmount"
        ).textContent = `${currency} ${amount}`;
        document.getElementById(
          "modalPhoneNumber"
        ).textContent = `${countryCode}${phoneNumber}`;

        //  inject per-MNO pin instructions for v2
        const mnoCode = (
          document.getElementById("selectedMno").value || ""
        ).trim();
        const isV2 = window.__activeConfVersion === "v2";
        const pinData =
          isV2 && window.__pinInstructions
            ? window.__pinInstructions[mnoCode]
            : null;

        const pinBox = document.getElementById("mnoPinInstructions");
        if (pinData) {
          if (typeof pinData === "string") {
            pinBox.innerHTML = pinData.replace(/\n/g, "<br>");
            pinBox.style.display = "block";
          } else {
            // structured object → pretty HTML
            const html = renderPinInstructions(
              pinData,
              document.documentElement.getAttribute("lang") || "en"
            );
            if (html) {
              pinBox.innerHTML = html;
              pinBox.style.display = "block";
            } else {
              pinBox.style.display = "none";
              pinBox.innerHTML = "";
            }
          }
        } else {
          pinBox.style.display = "none";
          pinBox.innerHTML = "";
        }

        document.getElementById("paymentDetails").style.display = "block";
        document.getElementById("loadingSpinner").style.display = "none";
        const payButton = document.getElementById("payBtn");
        payButton.disabled = false;
        payButton.textContent = "Pay";

        const errorMessageDiv = document.getElementById("errorMessage");
        errorMessageDiv.style.display = "none";
        errorMessageDiv.innerHTML = "";

        const paymentModal = new bootstrap.Modal(
          document.getElementById("paymentModal")
        );
        paymentModal.show();
      }

      function payButtonHandler() {
        const payButton = this;
        const loadingSpinner = document.getElementById("loadingSpinner");
        const paymentDetails = document.getElementById("paymentDetails");
        const errorMessageDiv = document.getElementById("errorMessage");
        const successMessageDiv = document.getElementById("successMessage");

        errorMessageDiv.style.display = "none";
        errorMessageDiv.innerHTML = "";
        successMessageDiv.style.display = "none";
        successMessageDiv.innerHTML = "";

        payButton.disabled = true;
        payButton.textContent = "Processing...";
        paymentDetails.style.display = "none";
        loadingSpinner.style.display = "block";

        submitForm();
      }

      document
        .getElementById("payBtn")
        .addEventListener("click", payButtonHandler);

      // --- processing → info notice helper (NEW) ---
      function showProcessingNotice(msg) {
        const modalFooter = document.querySelector(
          "#paymentModal .modal-footer"
        );
        const payButton = document.getElementById("payBtn");
        const paymentDetails = document.getElementById("paymentDetails");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const errorMessageDiv = document.getElementById("errorMessage");
        const successMessageDiv = document.getElementById("successMessage");

        loadingSpinner.style.display = "none";
        paymentDetails.style.display = "none";
        successMessageDiv.style.display = "none";

        errorMessageDiv.innerHTML = `<div class="alert alert-info" role="alert">
       <p>${
         msg || "Payment is processing. Please wait and check your account."
       }</p>
     </div>`;
        errorMessageDiv.style.display = "block";

        // Prevent duplicate attempts while it’s still processing
        payButton.disabled = true;
        payButton.textContent = "Processing";
        if (modalFooter) {
          modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
        }
      }

      function submitForm() {
        const form = document.getElementById("depositForm");
        const formData = new FormData(form);

        const countryCode = document
          .getElementById("countryCode")
          .textContent.trim()
          .replace("+", "");
        const payerMsisdnInput = document.getElementById("payerMsisdn");
        const payerMsisdn = countryCode + payerMsisdnInput.value.trim();
        formData.set("payerMsisdn", payerMsisdn);

        const countrySelect = document.getElementById("country");
        const selectedOption =
          countrySelect.options[countrySelect.selectedIndex];
        const currency = selectedOption.getAttribute("data-currency");
        formData.set("currency", currency);

        for (var pair of formData.entries()) {
          console.log(pair[0] + ": " + pair[1]);
        }

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "initiate_deposit.php", true);

        xhr.onload = function () {
          const modalFooter = document.querySelector(
            "#paymentModal .modal-footer"
          );
          const payButton = document.getElementById("payBtn");
          const loadingSpinner = document.getElementById("loadingSpinner");
          const paymentDetails = document.getElementById("paymentDetails");
          const errorMessageDiv = document.getElementById("errorMessage");
          const successMessageDiv = document.getElementById("successMessage");

          loadingSpinner.style.display = "none";

          if (xhr.status === 200) {
            let response;
            try {
              response = JSON.parse(xhr.responseText);
            } catch (e) {
              const raw = (xhr.responseText || "").trim();
              if (/(processing|pending|in\s*progress)/i.test(raw)) {
                showProcessingNotice(raw);
              } else {
                errorMessageDiv.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    <p>An error occurred: ${raw}</p>
                    <p>Please try again.</p>
                  </div>`;
                errorMessageDiv.style.display = "block";
                payButton.disabled = false;
                payButton.textContent = "Pay";
                paymentDetails.style.display = "block";
              }
              return;
            }

            if (response.success) {
              successMessageDiv.innerHTML = `
                <div class="alert alert-success" role="alert">
                  <h3 class="mb-3">Payment Successful!</h3>
                  <p>Thank you for your payment. It has been processed successfully.</p>
                  <p>Your transaction ID is: <strong>${response.transactionId}</strong>.</p>
                  <p>If you need any further assistance, please feel free to contact our support team.</p>
                </div>`;
              successMessageDiv.style.display = "block";
              modalFooter.innerHTML = `<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>`;
              const confirmButton = document.getElementById("submitBtn");
              confirmButton.disabled = true;
              confirmButton.textContent = "Paid";
              const prevButton = document.querySelector(
                "#step-4 .btn-secondary"
              );
              if (prevButton) prevButton.disabled = true;
              setTimeout(() => {
                form.reset();
              }, 3000);
            } else {
              const msg = String(
                response.errorMessage || response.message || ""
              ).trim();
              if (/(processing|pending|in\s*progress)/i.test(msg)) {
                showProcessingNotice(msg);
              } else {
                errorMessageDiv.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                    <p>An error occurred: ${msg}</p>
                    <p>Please try again.</p>
                  </div>`;
                errorMessageDiv.style.display = "block";
                successMessageDiv.style.display = "none";
                payButton.disabled = false;
                payButton.textContent = "Pay";
                paymentDetails.style.display = "block";
              }
            }
          } else {
            errorMessageDiv.innerHTML = `
              <div class="alert alert-danger" role="alert">
                <p>An error occurred while processing your payment.</p>
                <p>Please check your internet connection and try again.</p>
              </div>`;
            errorMessageDiv.style.display = "block";
            successMessageDiv.style.display = "none";
            payButton.disabled = false;
            payButton.textContent = "Pay";
            paymentDetails.style.display = "block";
          }
        };

        xhr.onerror = function () {
          const errorMessageDiv = document.getElementById("errorMessage");
          const payButton = document.getElementById("payBtn");
          const loadingSpinner = document.getElementById("loadingSpinner");
          const paymentDetails = document.getElementById("paymentDetails");

          loadingSpinner.style.display = "none";
          errorMessageDiv.innerHTML = `
            <p>An error occurred while processing your payment.</p>
            <p>Please check your internet connection and try again.</p>`;
          errorMessageDiv.style.display = "block";

          payButton.disabled = false;
          payButton.textContent = "Pay";
          paymentDetails.style.display = "block";
        };

        xhr.send(formData);
      }

      // On page load
      window.onload = function () {
        (async function () {
          const data = await loadAvailabilityData();
          if (data) {
            const { availabilityData, activeConfData } = data;
            updateMnoAvailability(availabilityData, activeConfData);
          }

          const selectedCountry = localStorage.getItem("selectedCountry");
          const selectedMno = localStorage.getItem("selectedMno");

          if (selectedCountry) {
            const countrySelect = document.getElementById("country");
            const options = countrySelect.options;

            for (let i = 0; i < options.length; i++) {
              if (options[i].value === selectedCountry) {
                options[i].selected = true;
                const event = new Event("change");
                countrySelect.dispatchEvent(event);
                break;
              }
            }

            const correspondents = mnoCorrespondents[selectedCountry];
            if (correspondents) {
              displayMnoCards(correspondents);

              if (selectedMno) {
                const mnoCards = document.querySelectorAll(".operator-card");
                mnoCards.forEach((card) => {
                  if (
                    card.querySelector("p").textContent.includes(selectedMno)
                  ) {
                    card.classList.add("selected");
                    document.getElementById("selectedMno").value = selectedMno;
                  }
                });
                const errorDiv = document.getElementById("mnoError");
                if (errorDiv) errorDiv.style.display = "none";
              } else {
                document.getElementById("selectedMno").value = "";
              }
            }
          }

          document.body.style.opacity = "1";
          document.querySelector(".preloader").style.display = "none";
        })();
      };

      function validateCountry() {
        const countrySelect = document.getElementById("country");
        const selectedCountry = countrySelect.value;
        const errorDiv = document.getElementById("countryError");

        if (!selectedCountry) {
          countrySelect.classList.add("is-invalid");
          errorDiv.style.display = "block";
        } else {
          countrySelect.classList.remove("is-invalid");
          countrySelect.classList.add("is-valid");
          errorDiv.style.display = "none";

          const correspondents = mnoCorrespondents[selectedCountry];
          if (correspondents) displayMnoCards(correspondents);

          const currency =
            countrySelect.options[countrySelect.selectedIndex].getAttribute(
              "data-currency"
            );
          updateStep3Details(selectedCountry, currency, correspondents);

          nextStep();
        }
      }
    </script>
  </body>
</html>
